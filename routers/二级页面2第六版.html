<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI树洞 - 专属对话空间</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome图标（头像、语音、设置等） -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- 自定义Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#6366F1', // 主色调（淡紫蓝，治愈系）
            secondary: '#F5F7FF', // 背景辅助色
            user: '#6366F1', // 用户对话气泡
            ai: '#E5E7EB',   // AI对话气泡
            text: '#1F2937', // 主文字色
            pay: '#F97316',   // 支付主题色（暖橙，醒目不突兀）
            experience: '#EC4899', // 体验套餐专属色（玫红，醒目吸引）
            emotion: '#10B981', // 情绪模块主色（青绿色，治愈）
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    :root {
      --app-height: 100%;
      --vv-top: 0px;
    }

    @layer utilities {
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .chat-bubble {
        border-radius: 1rem;
        max-width: 80%;
      }
      .user-bubble {
        border-bottom-right-radius: 0.25rem;
      }
      .ai-bubble {
        border-bottom-left-radius: 0.25rem;
      }
      /* 背景装饰元素动画 */
      .bg-shape {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.2;
        z-index: 0;
        animation: slowFloat 20s infinite alternate ease-in-out;
      }
      .bg-shape-1 {
        width: 400px;
        height: 400px;
        background: #6366F1;
        top: -100px;
        left: -100px;
        animation-delay: 0s;
      }
      .bg-shape-2 {
        width: 350px;
        height: 350px;
        background: #8B5CF6;
        bottom: -150px;
        right: -100px;
        animation-delay: 5s;
      }
      .bg-shape-3 {
        width: 300px;
        height: 300px;
        background: #A78BFA;
        top: 40%;
        right: 20%;
        animation-delay: 10s;
      }
      @keyframes slowFloat {
        0% {
          transform: translate(0, 0) scale(1);
        }
        100% {
          transform: translate(30px, 30px) scale(1.1);
        }
      }
      /* 支付弹窗遮罩 - 修复backdrop-blur样式 */
      .pay-mask {
        position: fixed;
        top: var(--vv-top);
        left: 0;
        right: 0;
        height: var(--app-height);
        background: rgba(0,0,0,0.5);
        z-index: 50;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-blur: 4px; /* 替换原无效写法，保证毛玻璃效果 */
      }
      /* 支付弹窗容器 - 匹配原页面阴影和圆角规范 */
      .pay-modal {
        width: 90%;
        max-width: 400px;
        max-height: calc(var(--app-height) * 0.8);
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.1); /* 匹配原页面阴影强度 */
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }
      /* 套餐卡片hover效果 - 和原页面交互一致 */
      .package-card {
        transition: all 0.3s ease;
      }
      .package-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1); /* 降低阴影强度，匹配原页面 */
      }
      .package-card.active {
        border-color: #6366F1;
        background: #F5F7FF;
      }
      /* 体验套餐专属样式 - 醒目玫红标识，区分普通套餐 */
      .experience-tag {
        background: #EC4899/10;
        color: #EC4899;
        font-weight: 600;
      }
      /* 套餐禁用样式 - 体验套餐购买后灰显不可选 */
      .package-card.disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
        background: #f9fafb;
      }
      /* 新增：情绪模块样式 */
      .emotion-card {
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
      }
      .emotion-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
        border-left-color: #10B981;
      }
      .question-item {
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .question-item:hover {
        background-color: #F5F7FF;
      }
      .answer-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      .answer-content.show {
        max-height: 500px;
      }
      .kbd-open .footer {
        display: none !important;
      }
    }
  </style>
</head>
<body class="relative min-h-screen flex flex-col bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 overflow-x-hidden">
  <!-- 背景装饰元素 -->
  <div class="bg-shape bg-shape-1"></div>
  <div class="bg-shape bg-shape-2"></div>
  <div class="bg-shape bg-shape-3"></div>

  <!-- 页面头部 - 完全保留原样式 -->
  <header class="bg-white/80 backdrop-blur-sm shadow-sm py-3 px-4 sticky top-0 z-30 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <a href="javascript:history.back()" class="text-text hover:text-primary transition-colors">
        <i class="fas fa-arrow-left text-lg"></i>
      </a>
      <h1 class="text-xl font-semibold text-text">AI树洞对话空间</h1>
    </div>
    <div class="flex items-center gap-3">
      <!-- 剩余语音条数提示（头部快捷展示）- 适配原头部布局 -->
      <div class="hidden sm:flex items-center gap-1 text-sm text-pay">
        <i class="fas fa-volume-up"></i>
        <span id="headerVoiceCount">剩余语音：<span class="font-medium">0</span>条</span>
      </div>
      <!-- 语音功能总开关 - 完全保留原样式 -->
      <div class="flex items-center gap-2">
        <span class="text-sm text-text hidden sm:inline">语音模式</span>
        <label class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="voiceMode" class="sr-only peer">
          <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
        </label>
      </div>
      <!-- 声音克隆设置按钮 - 完全保留原样式 -->
      <button id="cloneSettingBtn" class="text-text hover:text-primary transition-colors" title="声音克隆设置">
        <i class="fas fa-microphone-lines text-lg"></i>
      </button>
    </div>
  </header>

  <main class="flex-1 flex flex-col md:flex-row max-w-7xl mx-auto w-full px-2 py-4 gap-4 z-10 relative">
    <!-- 左侧：对话对象配置 + 声音克隆 + 付费套餐面板 - 新增1元体验套餐 -->
    <aside class="w-full md:w-80 bg-white/70 backdrop-blur-sm rounded-xl shadow-sm p-4 flex flex-col gap-4">
      <!-- 对话对象自定义 - 完全保留原代码 -->
      <div class="border-b pb-4 border-gray-200/50">
        <h2 class="text-lg font-medium text-text mb-3">对话对象设置</h2>
        <!-- 头像自定义 -->
        <div class="flex flex-col items-center gap-3 mb-4">
          <div class="w-24 h-24 rounded-full overflow-hidden border-2 border-primary/20 relative cursor-pointer group" id="avatarContainer">
            <img src="https://picsum.photos/200/200?random=1" alt="对话对象头像" id="avatarImg" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
              <i class="fas fa-camera text-white text-xl"></i>
            </div>
            <input type="file" id="avatarInput" accept="image/*" class="sr-only">
          </div>
          <span class="text-sm text-gray-500">点击更换头像（支持JPG/PNG）</span>
        </div>
        <!-- 昵称自定义 -->
        <div class="flex flex-col gap-2">
          <label class="text-sm text-gray-600">对方昵称</label>
          <input type="text" id="chatTargetName" value="我的AI树洞" class="w-full px-3 py-2 border border-gray-200/60 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all bg-white/90" placeholder="请输入对话对象的名字">
        </div>
      </div>

      <!-- 语音套餐付费模块 - 新增1元4条体验套餐（限1次） -->
      <div class="border-b pb-4 border-gray-200/50">
        <h2 class="text-lg font-medium text-text mb-3 flex items-center gap-2">
          <i class="fas fa-ticket-alt text-pay"></i>
          语音套餐
        </h2>
        <!-- 剩余语音条数 - 轻量化设计，不抢占视觉焦点 -->
        <div class="bg-pay/5 rounded-lg p-3 mb-4 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <i class="fas fa-volume-up text-pay text-xl"></i>
            <div>
              <p class="text-xs text-gray-500">当前剩余语音</p>
              <p class="text-xl font-bold text-pay" id="currentVoiceCount">0</p>
              <p class="text-xs text-gray-500">条（语音合成消耗）</p>
            </div>
          </div>
          <span class="text-xs text-gray-400">合成1条语音扣1次</span>
        </div>
        <!-- 套餐选项 - 新增1元4条体验套餐（置顶，限1次） -->
        <div class="flex flex-col gap-3 mb-3">
          <!-- 1元4条体验套餐（新增）- 限1次，专属玫红标识 -->
          <div class="package-card border border-gray-200/60 rounded-lg p-3 cursor-pointer" data-price="1.0" data-count="4" data-type="experience" data-limit="true">
            <div class="flex justify-between items-start mb-2">
              <h3 class="font-medium text-text">体验套餐</h3>
              <span class="bg-experience/10 text-experience px-2 py-1 rounded-full text-xs font-semibold">限1次</span>
            </div>
            <div class="flex items-baseline gap-2 mb-3">
              <span class="text-2xl font-bold text-experience">¥1.0</span>
              <span class="text-gray-500">/4条语音</span>
            </div>
            <p class="text-xs text-gray-500 mb-3">新人专属，仅可购买一次，体验语音对话功能</p>
            <button class="buy-package w-full py-2 bg-experience text-white rounded-lg hover:bg-experience/90 transition-colors text-sm">立即抢购</button>
          </div>
          <!-- 9.9元基础套餐 -->
          <div class="package-card active border border-gray-200/60 rounded-lg p-3 cursor-pointer" data-price="9.9" data-count="30" data-type="normal">
            <div class="flex justify-between items-start mb-2">
              <h3 class="font-medium text-text">基础套餐</h3>
              <span class="bg-pay/10 text-pay px-2 py-1 rounded-full text-xs font-medium">推荐</span>
            </div>
            <div class="flex items-baseline gap-2 mb-3">
              <span class="text-2xl font-bold text-pay">¥9.9</span>
              <span class="text-gray-500">/30条语音</span>
            </div>
            <p class="text-xs text-gray-500 mb-3">适合轻度使用，满足日常语音对话需求</p>
            <button class="buy-package w-full py-2 bg-pay text-white rounded-lg hover:bg-pay/90 transition-colors text-sm">立即购买</button>
          </div>
          <!-- 19.9元进阶套餐（7天无限使用） -->
          <div class="package-card border border-gray-200/60 rounded-lg p-3 cursor-pointer" data-price="19.9" data-count="0" data-type="unlimited" data-duration-days="7">
            <div class="flex justify-between items-start mb-2">
              <h3 class="font-medium text-text">进阶套餐</h3>
              <span class="bg-primary/10 text-primary px-2 py-1 rounded-full text-xs font-medium">高性价比</span>
            </div>
            <div class="flex items-baseline gap-2 mb-3">
              <span class="text-2xl font-bold text-pay">¥19.9</span>
              <span class="text-gray-500">/7天无限</span>
            </div>
            <p class="text-xs text-gray-500 mb-3">7天不限次数使用，适合高频连续体验</p>
            <button class="buy-package w-full py-2 bg-pay text-white rounded-lg hover:bg-pay/90 transition-colors text-sm">立即购买</button>
          </div>
        </div>
        <p class="text-xs text-gray-400 text-center">购买后立即到账，永久有效，不清零 | 体验套餐每个用户限购1次</p>
      </div>

      <!-- 声音克隆定制面板（默认隐藏）- 完全保留原代码 -->
      <div class="flex-1 flex flex-col gap-3" id="cloneSettingPanel" style="display: none;">
        <h2 class="text-lg font-medium text-text">声音克隆定制</h2>
        <p class="text-xs text-gray-500">自定义克隆声音的参数，打造专属语音</p>
        <!-- 语速 -->
        <div class="flex flex-col gap-2">
          <div class="flex justify-between items-center">
            <label class="text-sm text-gray-600">语速</label>
            <span class="text-xs text-gray-500" id="speedValue">1.0x</span>
          </div>
          <input type="range" id="voiceSpeed" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full h-2 bg-gray-200/60 rounded-lg appearance-none cursor-pointer accent-primary">
        </div>
        <!-- 音调 -->
        <div class="flex flex-col gap-2">
          <div class="flex justify-between items-center">
            <label class="text-sm text-gray-600">音调</label>
            <span class="text-xs text-gray-500" id="pitchValue">1.0x</span>
          </div>
          <input type="range" id="voicePitch" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full h-2 bg-gray-200/60 rounded-lg appearance-none cursor-pointer accent-primary">
        </div>
        <!-- 音量 -->
        <div class="flex flex-col gap-2">
          <div class="flex justify-between items-center">
            <label class="text-sm text-gray-600">音量</label>
            <span class="text-xs text-gray-500" id="volumeValue">1.0x</span>
          </div>
          <input type="range" id="voiceVolume" min="0" max="2.0" step="0.1" value="1.0" class="w-full h-2 bg-gray-200/60 rounded-lg appearance-none cursor-pointer accent-primary">
        </div>
        <!-- 克隆声音样本 -->
        <button id="cloneVoiceBtn" class="mt-2 w-full py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center justify-center gap-2 shadow-sm">
          <i class="fas fa-clone"></i>
          <span>开始克隆我的声音</span>
        </button>
        <p class="text-xs text-red-500 text-center mt-1">* 克隆前请确保已录制声音样本</p>
      </div>

      <!-- 新增：情绪分析报告模块 -->
      <div class="border-b pb-4 border-gray-200/50">
        <h2 class="text-lg font-medium text-text mb-3 flex items-center gap-2">
          <i class="fas fa-chart-pie text-emotion"></i>
          情绪分析报告
        </h2>
        <div class="bg-emotion/5 rounded-lg p-3 mb-3 emotion-card">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-text">当前情绪倾向</span>
            <span class="bg-emotion/10 text-emotion px-2 py-0.5 rounded-full text-xs font-semibold" id="emotionType">平和</span>
          </div>
          <!-- 情绪占比进度条 -->
          <div class="flex flex-col gap-2">
            <div class="flex justify-between text-xs text-gray-500">
              <span>愉悦</span>
              <span id="happyRate">65%</span>
            </div>
            <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
              <div class="h-full bg-green-500 rounded-full" id="happyBar" style="width: 65%"></div>
            </div>
            
            <div class="flex justify-between text-xs text-gray-500">
              <span>焦虑</span>
              <span id="anxiousRate">15%</span>
            </div>
            <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
              <div class="h-full bg-yellow-500 rounded-full" id="anxiousBar" style="width: 15%"></div>
            </div>
            
            <div class="flex justify-between text-xs text-gray-500">
              <span>低落</span>
              <span id="sadRate">10%</span>
            </div>
            <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
              <div class="h-full bg-blue-500 rounded-full" id="sadBar" style="width: 10%"></div>
            </div>
            
            <div class="flex justify-between text-xs text-gray-500">
              <span>愤怒</span>
              <span id="angryRate">10%</span>
            </div>
            <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
              <div class="h-full bg-red-500 rounded-full" id="angryBar" style="width: 10%"></div>
            </div>
          </div>
        </div>
        <button id="refreshEmotionBtn" class="w-full py-2 bg-emotion text-white rounded-lg hover:bg-emotion/90 transition-colors text-sm flex items-center justify-center gap-2">
          <i class="fas fa-sync-alt"></i>
          <span>重新分析情绪</span>
        </button>
      </div>

      <!-- 新增：个性化情绪疏导建议模块 -->
      <div class="border-b pb-4 border-gray-200/50">
        <h2 class="text-lg font-medium text-text mb-3 flex items-center gap-2">
          <i class="fas fa-lightbulb text-emotion"></i>
          情绪疏导建议
        </h2>
        <div class="bg-white/80 rounded-lg p-3 emotion-card" id="suggestionContainer">
          <p class="text-sm text-gray-700 mb-2"><i class="fas fa-check-circle text-emotion mr-2"></i>保持当前的平和状态，建议每天留出15分钟的放空时间</p>
          <p class="text-sm text-gray-700 mb-2"><i class="fas fa-check-circle text-emotion mr-2"></i>可以尝试轻量的户外运动（如散步），进一步缓解轻微焦虑</p>
          <p class="text-sm text-gray-700"><i class="fas fa-check-circle text-emotion mr-2"></i>睡前听舒缓的音乐，有助于提升睡眠质量，稳定情绪</p>
        </div>
      </div>

      <!-- 新增：常见心理问题解答库模块 -->
      <div class="flex-1 flex flex-col">
        <h2 class="text-lg font-medium text-text mb-3 flex items-center gap-2">
          <i class="fas fa-book-open text-emotion"></i>
          心理问题解答库
        </h2>
        <div class="flex-1 overflow-y-auto scrollbar-hide bg-white/80 rounded-lg p-2" id="questionLibrary">
          <!-- 问题项 -->
          <div class="question-item rounded-lg p-3 mb-2 border border-gray-100">
            <div class="flex justify-between items-center" onclick="toggleAnswer(this)">
              <span class="text-sm font-medium text-text">如何缓解日常焦虑情绪？</span>
              <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform"></i>
            </div>
            <div class="answer-content mt-2 pl-2 border-l-2 border-emotion">
              <p class="text-xs text-gray-600">1. 深呼吸法：4秒吸气→7秒屏息→8秒呼气，重复5次；</p>
              <p class="text-xs text-gray-600 mt-1">2. 拆解任务：把让你焦虑的事情拆分成最小执行单元，逐个完成；</p>
              <p class="text-xs text-gray-600 mt-1">3. 感官接地：专注于眼前的5件看得见的事物、4件能触摸到的事物、3件能听到的声音、2件能闻到的气味、1件能尝到的味道；</p>
              <p class="text-xs text-gray-600 mt-1">4. 适当倾诉：向信任的人表达自己的焦虑，不要独自承担。</p>
            </div>
          </div>

          <div class="question-item rounded-lg p-3 mb-2 border border-gray-100">
            <div class="flex justify-between items-center" onclick="toggleAnswer(this)">
              <span class="text-sm font-medium text-text">情绪低落时该怎么办？</span>
              <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform"></i>
            </div>
            <div class="answer-content mt-2 pl-2 border-l-2 border-emotion">
              <p class="text-xs text-gray-600">1. 允许自己低落：不要对抗负面情绪，接纳它的存在；</p>
              <p class="text-xs text-gray-600 mt-1">2. 做小事积累成就感：比如整理桌面、完成一次简单的运动、做一顿饭；</p>
              <p class="text-xs text-gray-600 mt-1">3. 接触自然：出门走10分钟，晒晒太阳，看看绿植；</p>
              <p class="text-xs text-gray-600 mt-1">4. 避免独处过久：和家人朋友保持轻度互动，哪怕只是聊聊天。</p>
            </div>
          </div>

          <div class="question-item rounded-lg p-3 mb-2 border border-gray-100">
            <div class="flex justify-between items-center" onclick="toggleAnswer(this)">
              <span class="text-sm font-medium text-text">如何控制易怒的情绪？</span>
              <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform"></i>
            </div>
            <div class="answer-content mt-2 pl-2 border-l-2 border-emotion">
              <p class="text-xs text-gray-600">1. 暂停法则：感到愤怒时，先暂停30秒再说话或行动；</p>
              <p class="text-xs text-gray-600 mt-1">2. 物理释放：捏减压球、捶打枕头、快走等方式释放情绪；</p>
              <p class="text-xs text-gray-600 mt-1">3. 分析愤怒根源：愤怒往往是未被满足的需求的外在表现，找到核心需求；</p>
              <p class="text-xs text-gray-600 mt-1">4. 用“我”陈述表达感受：比如“我感到生气，因为这件事让我觉得不被尊重”，而非指责他人。</p>
            </div>
          </div>

          <div class="question-item rounded-lg p-3 border border-gray-100">
            <div class="flex justify-between items-center" onclick="toggleAnswer(this)">
              <span class="text-sm font-medium text-text">怎样提升情绪自愈能力？</span>
              <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform"></i>
            </div>
            <div class="answer-content mt-2 pl-2 border-l-2 border-emotion">
              <p class="text-xs text-gray-600">1. 建立情绪日记：记录每天的情绪变化和触发事件，找到规律；</p>
              <p class="text-xs text-gray-600 mt-1">2. 培养爱好：投入能让你忘记时间的事情（绘画、音乐、手工等）；</p>
              <p class="text-xs text-gray-600 mt-1">3. 规律作息：睡眠不足会放大负面情绪，保证7-8小时睡眠；</p>
              <p class="text-xs text-gray-600 mt-1">4. 自我关怀：像对待好朋友一样对待自己，不要过度苛责。</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 底部提示 - 完全保留原代码 -->
      <div class="mt-auto text-xs text-gray-400 text-center">
        本页面为专属对话空间，内容仅你可见
      </div>
    </aside>

    <!-- 右侧：对话主区域 - 完全保留原代码，无任何修改 -->
    <div class="flex-1 flex flex-col bg-white/70 backdrop-blur-sm rounded-xl shadow-sm p-4">
      <!-- 对话内容区域 -->
      <div id="chatContainer" class="flex-1 overflow-y-auto scrollbar-hide pb-4 flex flex-col gap-4">
        <!-- 欢迎消息（初始状态）- 新增体验套餐提示 -->
        <div class="flex items-start gap-3 ai-chat-item">
          <img src="https://picsum.photos/200/200?random=1" alt="AI头像" class="w-10 h-10 rounded-full object-cover" id="chatTargetAvatar">
          <div class="chat-bubble ai-bubble bg-ai/80 px-4 py-3 text-text">
            <p class="font-medium text-sm mb-1" id="chatTargetNameShow">我的AI树洞</p>
            <p>你好呀～我是你的专属AI树洞，有什么想对我说的都可以哦～<br>新人专属<span class="text-experience font-medium">1元4条语音体验套餐</span>限时抢，仅可购买一次，开启语音模式更便捷～</p>
          </div>
        </div>
      </div>

      <!-- 输入区域 -->
      <div class="border-t pt-4 mt-2 border-gray-200/50">
        <form id="chatForm" class="flex flex-col gap-3">
          <div class="flex items-center gap-2">
            <!-- 语音输入按钮（语音模式开启时显示） -->
            <button type="button" id="voiceInputBtn" class="w-10 h-10 rounded-full bg-gray-100/80 flex items-center justify-center text-text hover:bg-primary hover:text-white transition-colors hidden" title="按住说话">
              <i class="fas fa-microphone"></i>
            </button>
            <!-- 输入框 -->
            <textarea id="chatInput" rows="2" placeholder="输入你想对我说的话...按回车发送" class="flex-1 px-3 py-2 border border-gray-200/60 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary resize-none transition-all bg-white/90"></textarea>
            <!-- 发送按钮 -->
            <button type="submit" class="w-10 h-10 rounded-full bg-primary text-white hover:bg-primary/90 transition-colors flex items-center justify-center shadow-sm">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          <p class="text-xs text-gray-400 text-right">
            <span id="voiceStatus">语音模式已关闭（新人可购<span class="text-experience font-medium">1元体验套餐</span>）</span> | 支持回车发送
          </p>
        </form>
      </div>
    </div>
  </main>

  <!-- 支付弹窗（默认隐藏）- 适配体验套餐显示 -->
  <div class="pay-mask" id="payMask" style="display: none;">
    <div class="pay-modal">
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-semibold text-text text-lg" id="payModalTitle">购买1.0元体验套餐</h3>
        <button id="closePayModal" class="text-gray-400 hover:text-text p-1">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="bg-gray-50 rounded-lg p-3 mb-4 text-center">
        <p class="text-sm text-gray-500">购买后将获得</p>
        <p class="text-xl font-bold" id="payModalCount">4条</p>
        <p class="text-sm text-gray-500" id="payModalTip">语音合成次数（永久有效 | 本套餐限购1次）</p>
      </div>
      <!-- 支付方式选择 - 样式匹配原页面按钮规范 -->
      <div class="flex gap-3 mb-4">
        <div class="flex-1 border border-primary rounded-lg p-2 cursor-pointer pay-method active" data-type="wechat">
          <div class="flex items-center justify-center gap-2">
            <i class="fab fa-weixin text-green-600 text-xl"></i>
            <span class="text-sm text-text">微信支付</span>
          </div>
        </div>
        <div class="flex-1 border border-gray-200 rounded-lg p-2 cursor-pointer pay-method" data-type="alipay">
          <div class="flex items-center justify-center gap-2">
            <i class="fab fa-alipay text-blue-600 text-xl"></i>
            <span class="text-sm text-text">支付宝</span>
          </div>
        </div>
      </div>
      <!-- 支付按钮 - 适配体验套餐颜色 -->
      <button id="submitPay" class="w-full py-3 bg-pay text-white rounded-lg hover:bg-pay/90 transition-colors flex items-center justify-center gap-2 font-medium shadow-sm">
        <span>立即支付</span>
        <span id="payModalPrice">¥1.0</span>
      </button>
    </div>
  </div>

  <!-- 新增：页面底部版权声明 - JSHT捷思慧图科技公司 -->
  <footer class="footer bg-white/80 backdrop-blur-sm py-4 px-4 mt-6 shadow-inner z-20">
    <div class="max-w-7xl mx-auto text-center text-sm text-gray-600 font-medium">
      版权所有 © JSHT捷思慧图科技公司 | 翻版必究
    </div>
  </footer>

  <script>
    // ========== 基础元素获取 ==========
    const avatarContainer = document.getElementById('avatarContainer');
    const avatarImg = document.getElementById('avatarImg');
    const avatarInput = document.getElementById('avatarInput');
    const chatTargetName = document.getElementById('chatTargetName');
    const chatTargetNameShow = document.getElementById('chatTargetNameShow');
    const chatTargetAvatar = document.getElementById('chatTargetAvatar');
    const voiceMode = document.getElementById('voiceMode');
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    const voiceStatus = document.getElementById('voiceStatus');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const chatContainer = document.getElementById('chatContainer');
    const cloneSettingBtn = document.getElementById('cloneSettingBtn');
    const cloneSettingPanel = document.getElementById('cloneSettingPanel');
    const cloneVoiceBtn = document.getElementById('cloneVoiceBtn');
    const voiceSpeed = document.getElementById('voiceSpeed');
    const voicePitch = document.getElementById('voicePitch');
    const voiceVolume = document.getElementById('voiceVolume');
    const speedValue = document.getElementById('speedValue');
    const pitchValue = document.getElementById('pitchValue');
    const volumeValue = document.getElementById('volumeValue');
    // 付费相关元素
    const currentVoiceCount = document.getElementById('currentVoiceCount');
    const headerVoiceCount = document.getElementById('headerVoiceCount');
    const packageCards = document.querySelectorAll('.package-card');
    const buyPackageBtns = document.querySelectorAll('.buy-package');
    const payMask = document.getElementById('payMask');
    const closePayModal = document.getElementById('closePayModal');
    const payModalTitle = document.getElementById('payModalTitle');
    const payModalCount = document.getElementById('payModalCount');
    const payModalPrice = document.getElementById('payModalPrice');
    const payModalTip = document.getElementById('payModalTip');
    const payMethods = document.querySelectorAll('.pay-method');
    const submitPay = document.getElementById('submitPay');
    // 新增：情绪模块元素
    const refreshEmotionBtn = document.getElementById('refreshEmotionBtn');
    const emotionType = document.getElementById('emotionType');
    const happyRate = document.getElementById('happyRate');
    const happyBar = document.getElementById('happyBar');
    const anxiousRate = document.getElementById('anxiousRate');
    const anxiousBar = document.getElementById('anxiousBar');
    const sadRate = document.getElementById('sadRate');
    const sadBar = document.getElementById('sadBar');
    const angryRate = document.getElementById('angryRate');
    const angryBar = document.getElementById('angryBar');
    const suggestionContainer = document.getElementById('suggestionContainer');

    // ========== 全局变量（接口参数/状态） ==========
    let isListening = false; // 是否正在语音识别
    let speechInstance = null; // 语音合成实例
    let voiceCount = 0; // 剩余语音条数（核心付费状态）
    let currentBuyPackage = { price: 1.0, count: 4, name: '体验套餐', type: 'experience', limit: true }; // 默认选中体验套餐
    let currentPayMethod = 'wechat'; // 当前选中的支付方式：wechat/alipay
    let hasBoughtExperience = false; // 标记是否已购买体验套餐（初始false，从本地/后台读取）
    let unlimitedUntil = null; // 7天无限使用到期时间（时间戳）
    // 声音克隆参数（传给后台API）
    const cloneConfig = {
      speed: 1.0,    // 语速
      pitch: 1.0,    // 音调
      volume: 1.0,   // 音量
      voiceId: null  // 克隆后的声音ID（后台返回）
    };
    // 新增：情绪数据
    const emotionData = {
      happy: 65,
      anxious: 15,
      sad: 10,
      angry: 10
    };
    const isMobile = window.matchMedia('(max-width: 768px)').matches
      || /Mobi|Android|iP(ad|hone|od)/i.test(navigator.userAgent);
    const isiOS = /iP(ad|hone|od)/.test(navigator.userAgent)
      || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const kbdClassTarget = document.documentElement;
    let scrollLockY = 0;

    function syncViewport() {
      const viewport = window.visualViewport;
      const height = viewport ? viewport.height : window.innerHeight;
      const offsetTop = viewport ? viewport.offsetTop : 0;
      document.documentElement.style.setProperty('--app-height', `${height}px`);
      document.documentElement.style.setProperty('--vv-top', `${offsetTop}px`);
    }

    function setKeyboardOpen(isOpen) {
      kbdClassTarget.classList.toggle('kbd-open', isOpen);
    }

    function updateKeyboardState() {
      if (!isMobile || !window.visualViewport) {
        return;
      }
      const keyboardOpen = window.innerHeight - window.visualViewport.height > 120;
      setKeyboardOpen(keyboardOpen);
    }

    function enableKeyboardDetection() {
      if (!isMobile) {
        setKeyboardOpen(false);
        return;
      }
      if (window.visualViewport) {
        updateKeyboardState();
        window.visualViewport.addEventListener('resize', updateKeyboardState);
        window.visualViewport.addEventListener('scroll', updateKeyboardState);
        return;
      }
      document.addEventListener('focusin', () => setKeyboardOpen(true));
      document.addEventListener('focusout', () => setKeyboardOpen(false));
    }

    function lockBodyScroll() {
      scrollLockY = window.scrollY || window.pageYOffset || 0;
      document.body.style.position = 'fixed';
      document.body.style.top = `-${scrollLockY}px`;
      document.body.style.left = '0';
      document.body.style.right = '0';
      document.body.style.width = '100%';
    }

    function unlockBodyScroll() {
      document.body.style.position = '';
      document.body.style.top = '';
      document.body.style.left = '';
      document.body.style.right = '';
      document.body.style.width = '';
      window.scrollTo(0, scrollLockY);
      if (isiOS) {
        requestAnimationFrame(() => {
          document.body.style.transform = 'translateZ(0)';
          requestAnimationFrame(() => {
            document.body.style.transform = '';
          });
        });
      }
    }

    function showPayModal() {
      payMask.style.display = 'flex';
      lockBodyScroll();
    }

    function hidePayModal() {
      payMask.style.display = 'none';
      unlockBodyScroll();
    }

    // ========== 初始化页面 ==========
    window.onload = function() {
      syncViewport();
      window.addEventListener('resize', syncViewport);
      window.addEventListener('orientationchange', syncViewport);
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', syncViewport);
        window.visualViewport.addEventListener('scroll', syncViewport);
      }
      enableKeyboardDetection();
      // 同步初始昵称和头像
      syncChatTargetInfo();
      // 同步语音模式状态
      toggleVoiceMode();
      // 初始化剩余语音条数+检查体验套餐购买状态
      initVoiceCount();
      // 初始化7天无限使用状态
      initUnlimitedStatus();
      // 初始化体验套餐状态（禁用/可用）
      initExperiencePackageStatus();
      // 绑定付费相关事件
      bindPayEvents();
      // 新增：绑定情绪模块事件
      bindEmotionEvents();
    };

    // ========== 初始化剩余语音条数+体验套餐购买状态（对接后台用户套餐接口） ==========
    async function initVoiceCount() {
      try {
        // ========== 用户套餐查询API（替换为你的后台接口） ==========
        // const response = await fetch('YOUR_USER_PACKAGE_URL', {
        //   method: 'GET',
        //   headers: {
        //     'Content-Type': 'application/json',
        //     // 'Authorization': 'Bearer ' + localStorage.getItem('token') // 用户鉴权
        //   }
        // });
        // const res = await response.json();
        // // 从后台获取剩余语音条数+是否购买过体验套餐
        // voiceCount = res.data?.voiceCount || 0;
        // hasBoughtExperience = res.data?.hasBoughtExperience || false;

        // 本地测试默认值，实际对接后删除
        voiceCount = 0;
        hasBoughtExperience = localStorage.getItem('hasBoughtExperience') === 'true'; // 本地存储标记
        unlimitedUntil = parseInt(localStorage.getItem('unlimitedUntil') || '0', 10) || null;
        // 更新页面显示
        updateVoiceCountDisplay();
      } catch (error) {
        console.error('查询用户套餐失败：', error);
        voiceCount = 0;
        hasBoughtExperience = localStorage.getItem('hasBoughtExperience') === 'true';
        unlimitedUntil = parseInt(localStorage.getItem('unlimitedUntil') || '0', 10) || null;
        updateVoiceCountDisplay();
      }
    }

    // ========== 初始化体验套餐状态 - 已购买则灰显禁用 ==========
    function initExperiencePackageStatus() {
      const experienceCard = document.querySelector('.package-card[data-type="experience"]');
      if (hasBoughtExperience && experienceCard) {
        experienceCard.classList.add('disabled');
        experienceCard.classList.remove('active');
        // 自动选中基础套餐
        const basicCard = document.querySelector('.package-card[data-price="9.9"]');
        basicCard?.classList.add('active');
        currentBuyPackage = { price: 9.9, count: 30, name: '基础套餐', type: 'normal', limit: false };
      }
    }

    // ========== 更新剩余语音条数页面显示 ==========
    function updateVoiceCountDisplay() {
      const unlimitedActive = isUnlimitedActive();
      currentVoiceCount.textContent = unlimitedActive ? '无限' : voiceCount;
      headerVoiceCount.innerHTML = `剩余语音：<span class="font-medium">${unlimitedActive ? '无限' : voiceCount}</span>条`;
      // 更新语音模式状态提示（新增体验套餐引导）
      if (voiceMode.checked) {
        voiceStatus.textContent = unlimitedActive
          ? '语音模式已开启（7天无限使用）'
          : voiceCount > 0 
            ? '语音模式已开启（按住麦克风说话）' 
            : hasBoughtExperience
              ? '语音模式已开启（剩余语音不足，请购买套餐）'
              : '语音模式已开启（可购<span class="text-experience font-medium">1元体验套餐</span>）';
        voiceStatus.style.color = unlimitedActive ? '#10B981' : voiceCount > 0 ? '#6366F1' : hasBoughtExperience ? '#F97316' : '#EC4899';
      } else {
        voiceStatus.textContent = unlimitedActive
          ? '语音模式已关闭（7天无限可用）'
          : voiceCount > 0 
            ? '语音模式已关闭' 
            : hasBoughtExperience
              ? '语音模式已关闭（需购买套餐使用）'
              : '语音模式已关闭（新人可购<span class="text-experience font-medium">1元体验套餐</span>）';
        voiceStatus.style.color = unlimitedActive ? '#10B981' : voiceCount > 0 ? '#9CA3AF' : hasBoughtExperience ? '#F97316' : '#EC4899';
      }
    }

    // ========== 绑定付费相关事件（新增体验套餐逻辑） ==========
    function bindPayEvents() {
      // 套餐卡片选中切换（排除禁用的体验套餐）
      packageCards.forEach(card => {
        card.addEventListener('click', () => {
          if (card.classList.contains('disabled')) return;
          packageCards.forEach(c => c.classList.remove('active'));
          card.classList.add('active');
          // 更新当前选中套餐
          currentBuyPackage = {
            price: parseFloat(card.dataset.price),
            count: parseInt(card.dataset.count),
            name: card.querySelector('h3').textContent,
            type: card.dataset.type,
            limit: card.dataset.limit === 'true',
            durationDays: parseInt(card.dataset.durationDays || '0', 10)
          };
        });
      });

      // 购买套餐按钮点击 - 打开支付弹窗（适配套餐样式）
      buyPackageBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const card = btn.closest('.package-card');
          if (card.classList.contains('disabled')) return;
          // 触发套餐卡片选中
          card.click();
          // 更新支付弹窗内容+样式
          payModalTitle.textContent = `购买${currentBuyPackage.price}元${currentBuyPackage.name}`;
          payModalCount.textContent = currentBuyPackage.type === 'unlimited'
            ? `${currentBuyPackage.durationDays}天无限`
            : `${currentBuyPackage.count}条`;
          payModalPrice.textContent = `¥${currentBuyPackage.price}`;
          // 体验套餐显示专属提示，普通套餐显示默认提示
          if (currentBuyPackage.type === 'experience') {
            payModalTip.textContent = '语音合成次数（永久有效 | 本套餐限购1次）';
            payModalCount.style.color = '#EC4899';
            submitPay.style.backgroundColor = '#EC4899';
            submitPay.style.hover = '#EC4899/90';
          } else if (currentBuyPackage.type === 'unlimited') {
            payModalTip.textContent = `语音合成次数（${currentBuyPackage.durationDays}天内不限次数）`;
            payModalCount.style.color = '#10B981';
            submitPay.style.backgroundColor = '#10B981';
            submitPay.style.hover = '#10B981/90';
          } else {
            payModalTip.textContent = '语音合成次数（永久有效）';
            payModalCount.style.color = '#F97316';
            submitPay.style.backgroundColor = '#F97316';
            submitPay.style.hover = '#F97316/90';
          }
          // 显示支付弹窗
          showPayModal();
        });
      });

      // 关闭支付弹窗
      closePayModal.addEventListener('click', () => {
        hidePayModal();
      });
      // 点击遮罩关闭弹窗
      payMask.addEventListener('click', (e) => {
        if (e.target === payMask) hidePayModal();
      });

      // 支付方式选择切换
      payMethods.forEach(method => {
        method.addEventListener('click', () => {
          payMethods.forEach(m => m.classList.remove('active', 'border-primary'));
          payMethods.forEach(m => m.classList.add('border-gray-200'));
          method.classList.add('active', 'border-primary');
          method.classList.remove('border-gray-200');
          // 更新当前支付方式
          currentPayMethod = method.dataset.type;
        });
      });

      // 提交支付 - 调用支付接口（新增体验套餐限购逻辑）
      submitPay.addEventListener('click', async () => {
        // 体验套餐二次校验：已购买则直接关闭弹窗
        if (currentBuyPackage.limit && hasBoughtExperience) {
          alert('体验套餐每个用户仅可购买一次，你已购买过～');
          hidePayModal();
          return;
        }
        // 按钮loading状态
        submitPay.disabled = true;
        submitPay.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span>支付中...</span>';
        try {
          // 调用支付接口
          const payResult = await submitPayRequest();
          if (payResult.success) {
            // 支付成功 - 关闭弹窗、更新剩余语音、提示用户
            hidePayModal();
            if (currentBuyPackage.type === 'unlimited') {
              setUnlimitedUntil(currentBuyPackage.durationDays);
            } else {
              voiceCount += currentBuyPackage.count;
            }
            updateVoiceCountDisplay();
            // 体验套餐：标记已购买+禁用卡片+本地存储
            if (currentBuyPackage.type === 'experience') {
              hasBoughtExperience = true;
              localStorage.setItem('hasBoughtExperience', 'true'); // 本地持久化
              initExperiencePackageStatus(); // 禁用体验套餐卡片
              alert(`新人体验套餐购买成功！已为你添加${currentBuyPackage.count}条语音，当前剩余${voiceCount}条～`);
            } else if (currentBuyPackage.type === 'unlimited') {
              alert(`购买成功！已为你开启${currentBuyPackage.durationDays}天无限使用，立即生效～`);
            } else {
              alert(`购买成功！已为你添加${currentBuyPackage.count}条语音，当前剩余${voiceCount}条～`);
            }
            // 同步更新到后台（防止页面刷新后数据丢失）
            await syncVoiceCountToServer();
          } else {
            alert(`支付失败：${payResult.msg || '请重新尝试'}`);
          }
        } catch (error) {
          console.error('支付请求失败：', error);
          alert('支付异常，请检查网络后重新尝试');
        } finally {
          // 恢复按钮状态
          submitPay.disabled = false;
          submitPay.innerHTML = `<span>立即支付</span><span id="payModalPrice">¥${currentBuyPackage.price}</span>`;
        }
      });
    }

    // ========== 提交支付请求（对接微信/支付宝支付接口） ==========
    async function submitPayRequest() {
      try {
        // ========== 支付下单API（替换为你的后台接口） ==========
        const response = await fetch('YOUR_PAY_ORDER_URL', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // 'Authorization': 'Bearer ' + localStorage.getItem('token') // 用户鉴权
          },
          body: JSON.stringify({
            price: currentBuyPackage.price, // 套餐金额
            voiceCount: currentBuyPackage.count, // 购买的语音条数
            payMethod: currentPayMethod, // 支付方式：wechat/alipay
            userId: '当前用户ID', // 关联用户
            packageType: currentBuyPackage.type, // 套餐类型：experience/normal
            limit: currentBuyPackage.limit // 是否限购
          })
        });

        const res = await response.json();
        if (res.code === 200) {
          return {
            success: true,
            msg: '支付成功'
          };
        } else {
          return {
            success: false,
            msg: res.msg
          };
        }
      } catch (error) {
        throw new Error(error.message);
      }
    }

    // ========== 同步语音条数+体验套餐状态到后台 ==========
    async function syncVoiceCountToServer() {
      try {
        // ========== 同步数据API（替换为你的后台接口） ==========
        await fetch('YOUR_SYNC_VOICE_COUNT_URL', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // 'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({
            voiceCount: voiceCount,
            userId: '当前用户ID',
            hasBoughtExperience: hasBoughtExperience, // 同步体验套餐购买状态
            unlimitedUntil: unlimitedUntil // 同步7天无限使用到期时间
          })
        });
      } catch (error) {
        console.error('同步语音条数失败：', error);
      }
    }

    // ========== 对话对象自定义：头像+昵称 - 完全保留原代码 ==========
    avatarContainer.addEventListener('click', () => avatarInput.click());
    avatarInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const src = event.target.result;
          avatarImg.src = src;
          chatTargetAvatar.src = src;
        };
        reader.readAsDataURL(file);
      }
    });

    chatTargetName.addEventListener('input', syncChatTargetInfo);
    function syncChatTargetInfo() {
      const name = chatTargetName.value.trim() || '我的AI树洞';
      chatTargetNameShow.textContent = name;
      chatTargetAvatar.src = avatarImg.src;
    }

    // ========== 声音克隆参数调节 - 完全保留原代码 ==========
    voiceSpeed.addEventListener('input', (e) => {
      cloneConfig.speed = parseFloat(e.target.value);
      speedValue.textContent = `${cloneConfig.speed.toFixed(1)}x`;
    });
    voicePitch.addEventListener('input', (e) => {
      cloneConfig.pitch = parseFloat(e.target.value);
      pitchValue.textContent = `${cloneConfig.pitch.toFixed(1)}x`;
    });
    voiceVolume.addEventListener('input', (e) => {
      cloneConfig.volume = parseFloat(e.target.value);
      volumeValue.textContent = `${cloneConfig.volume.toFixed(1)}x`;
    });

    cloneSettingBtn.addEventListener('click', () => {
      cloneSettingPanel.style.display = cloneSettingPanel.style.display === 'none' ? 'flex' : 'none';
    });

    // ========== 语音模式开关（适配体验套餐提示） ==========
    voiceMode.addEventListener('change', toggleVoiceMode);
    function toggleVoiceMode() {
      const isOpen = voiceMode.checked;
      voiceInputBtn.style.display = isOpen ? 'flex' : 'none';
      // 根据剩余语音+体验套餐状态更新提示
      if (isOpen) {
        const unlimitedActive = isUnlimitedActive();
        voiceStatus.textContent = unlimitedActive
          ? '语音模式已开启（7天无限使用）'
          : voiceCount > 0 
            ? '语音模式已开启（按住麦克风说话）' 
            : hasBoughtExperience
              ? '语音模式已开启（剩余语音不足，请购买套餐）'
              : '语音模式已开启（可购<span class="text-experience font-medium">1元体验套餐</span>）';
        voiceStatus.style.color = unlimitedActive ? '#10B981' : voiceCount > 0 ? '#6366F1' : hasBoughtExperience ? '#F97316' : '#EC4899';
      } else {
        const unlimitedActive = isUnlimitedActive();
        voiceStatus.textContent = unlimitedActive
          ? '语音模式已关闭（7天无限可用）'
          : voiceCount > 0 
            ? '语音模式已关闭' 
            : hasBoughtExperience
              ? '语音模式已关闭（需购买套餐使用）'
              : '语音模式已关闭（新人可购<span class="text-experience font-medium">1元体验套餐</span>）';
        voiceStatus.style.color = unlimitedActive ? '#10B981' : voiceCount > 0 ? '#9CA3AF' : hasBoughtExperience ? '#F97316' : '#EC4899';
      }
    }

    // ========== 7天无限使用状态处理 ==========
    function initUnlimitedStatus() {
      normalizeUnlimitedState();
      updateVoiceCountDisplay();
    }

    function setUnlimitedUntil(durationDays) {
      const now = Date.now();
      unlimitedUntil = now + durationDays * 24 * 60 * 60 * 1000;
      localStorage.setItem('unlimitedUntil', String(unlimitedUntil));
      normalizeUnlimitedState();
    }

    function isUnlimitedActive() {
      normalizeUnlimitedState();
      return !!unlimitedUntil;
    }

    function normalizeUnlimitedState() {
      if (unlimitedUntil && Date.now() > unlimitedUntil) {
        unlimitedUntil = null;
        localStorage.removeItem('unlimitedUntil');
      }
    }

    // ========== 核心功能：文字对话 - 完全保留原代码 ==========
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const content = chatInput.value.trim();
      if (!content) return;

      chatInput.value = '';
      addChatItem('user', content);
      scrollToBottom();
      await sendTextMessage(content);
    });

    function addChatItem(type, content) {
      const div = document.createElement('div');
      div.className = `${type === 'user' ? 'flex justify-end' : 'flex items-start gap-3'} mb-2 ${type}-chat-item`;
      
      if (type === 'user') {
        div.innerHTML = `
          <div class="chat-bubble user-bubble bg-user px-4 py-3 text-white">
            ${content}
          </div>
        `;
      } else {
        div.innerHTML = `
          <img src="${chatTargetAvatar.src}" alt="AI头像" class="w-10 h-10 rounded-full object-cover">
          <div class="chat-bubble ai-bubble bg-ai/80 px-4 py-3 text-text">
            <p class="font-medium text-sm mb-1">${chatTargetNameShow.textContent}</p>
            ${content}
          </div>
        `;
      }
      chatContainer.appendChild(div);
    }

    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function sendTextMessage(content) {
      // 模拟AI回复
      addChatItem('ai', '我收到你的消息啦～正在认真思考怎么回复你...');
      scrollToBottom();
      
      // 模拟接口延迟
      setTimeout(() => {
        // 移除加载中的消息
        const lastItem = chatContainer.lastChild;
        if (lastItem && lastItem.querySelector('.ai-bubble') && lastItem.textContent.includes('正在认真思考')) {
          chatContainer.removeChild(lastItem);
        }
        
        // 新增：调用情绪分析（基于用户输入）
        analyzeEmotion(content);
        
        // 添加真实回复
        addChatItem('ai', `你说的「${content}」我都听明白啦～${getRandomComfort()}`);
        scrollToBottom();
      }, 1000);
    }

    function getRandomComfort() {
      const comforts = [
        '不管发生什么，我都会在这里陪着你～',
        '能说出来就很棒啦，不要把情绪都憋在心里～',
        '你的感受真的很重要，不用觉得不好意思～',
        '慢慢来，一切都会慢慢变好的✨'
      ];
      return comforts[Math.floor(Math.random() * comforts.length)];
    }

    // ========== 新增：情绪模块核心功能 ==========
    function bindEmotionEvents() {
      // 重新分析情绪按钮点击事件
      refreshEmotionBtn.addEventListener('click', () => {
        // 按钮loading状态
        refreshEmotionBtn.disabled = true;
        refreshEmotionBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span>分析中...</span>';
        
        // 模拟情绪分析接口请求
        setTimeout(() => {
          // 随机生成新的情绪数据（模拟真实分析结果）
          emotionData.happy = Math.floor(Math.random() * 40) + 50; // 50-90
          emotionData.anxious = Math.floor(Math.random() * 20); // 0-20
          emotionData.sad = Math.floor(Math.random() * 20); // 0-20
          emotionData.angry = Math.floor(Math.random() * 10); // 0-10
          
          // 修正总和为100（避免数据异常）
          const total = emotionData.happy + emotionData.anxious + emotionData.sad + emotionData.angry;
          if (total > 100) {
            const exceed = total - 100;
            emotionData.happy -= exceed;
          }
          
          // 更新情绪显示
          updateEmotionDisplay();
          // 更新疏导建议
          updateSuggestion();
          
          // 恢复按钮状态
          refreshEmotionBtn.disabled = false;
          refreshEmotionBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i><span>重新分析情绪</span>';
          
          alert('情绪分析完成！已更新你的情绪报告和疏导建议～');
        }, 1500);
      });
    }

    // 更新情绪显示（进度条+占比）
    function updateEmotionDisplay() {
      // 更新数值和进度条
      happyRate.textContent = `${emotionData.happy}%`;
      happyBar.style.width = `${emotionData.happy}%`;
      
      anxiousRate.textContent = `${emotionData.anxious}%`;
      anxiousBar.style.width = `${emotionData.anxious}%`;
      
      sadRate.textContent = `${emotionData.sad}%`;
      sadBar.style.width = `${emotionData.sad}%`;
      
      angryRate.textContent = `${emotionData.angry}%`;
      angryBar.style.width = `${emotionData.angry}%`;
      
      // 更新主情绪类型
      let mainEmotion = '平和';
      if (emotionData.happy >= 80) {
        mainEmotion = '愉悦';
      } else if (emotionData.anxious >= 30) {
        mainEmotion = '焦虑';
      } else if (emotionData.sad >= 30) {
        mainEmotion = '低落';
      } else if (emotionData.angry >= 20) {
        mainEmotion = '愤怒';
      }
      emotionType.textContent = mainEmotion;
    }

    // 更新个性化情绪疏导建议
    function updateSuggestion() {
      let suggestions = [];
      const mainEmotion = emotionType.textContent;
      
      switch (mainEmotion) {
        case '愉悦':
          suggestions = [
            '<i class="fas fa-check-circle text-emotion mr-2"></i>继续保持这份好心情，建议记录下让你开心的小事～',
            '<i class="fas fa-check-circle text-emotion mr-2"></i>可以和身边的人分享你的快乐，让美好加倍✨',
            '<i class="fas fa-check-circle text-emotion mr-2"></i>尝试做一些喜欢的小事，延长愉悦的情绪体验'
          ];
          break;
        case '焦虑':
          suggestions = [
            '<i class="fas fa-check-circle text-emotion mr-2"></i>试试478呼吸法：4秒吸气→7秒屏息→8秒呼气，重复5次',
            '<i class="fas fa-check-circle text-emotion mr-2"></i>把焦虑的事情写下来，拆解成最小的可执行步骤',
            '<i class="fas fa-check-circle text-emotion mr-2"></i>暂时离开让你焦虑的环境，做3分钟简单的拉伸'
          ];
          break;
        case '低落':
          suggestions = [
            '<i class="fas fa-check-circle text-emotion mr-2"></i>允许自己低落，不用强迫自己立刻好起来',
            '<i class="fas fa-check-circle text-emotion mr-2"></i>出门晒10分钟太阳，光照能有效改善情绪',
            '<i class="fas fa-check-circle text-emotion mr-2"></i>和信任的人聊聊天，哪怕只是说说废话也好'
          ];
          break;
        case '愤怒':
          suggestions = [
            '<i class="fas fa-check-circle text-emotion mr-2"></i>先暂停30秒再说话/行动，避免冲动做出决定',
            '<i class="fas fa-check-circle text-emotion mr-2"></i>找个没人的地方大喊几声，或捏减压球释放情绪',
            '<i class="fas fa-check-circle text-emotion mr-2"></i>写下让你愤怒的事情，分析背后真正的需求'
          ];
          break;
        default: // 平和
          suggestions = [
            '<i class="fas fa-check-circle text-emotion mr-2"></i>保持当前的平和状态，建议每天留出15分钟的放空时间',
            '<i class="fas fa-check-circle text-emotion mr-2"></i>可以尝试轻量的户外运动（如散步），进一步缓解轻微焦虑',
            '<i class="fas fa-check-circle text-emotion mr-2"></i>睡前听舒缓的音乐，有助于提升睡眠质量，稳定情绪'
          ];
          break;
      }
      
      // 更新页面建议内容
      suggestionContainer.innerHTML = suggestions.map(s => `<p class="text-sm text-gray-700 mb-2">${s}</p>`).join('');
    }

    // 基于用户输入分析情绪（模拟）
    function analyzeEmotion(content) {
      // 关键词匹配情绪
      const happyKeywords = ['开心', '快乐', '高兴', '棒', '好', '幸福', '满足'];
      const anxiousKeywords = ['焦虑', '着急', '担心', '害怕', '紧张', '压力', '慌'];
      const sadKeywords = ['难过', '伤心', '低落', '想哭', '失望', '孤独'];
      const angryKeywords = ['生气', '愤怒', '烦', '讨厌', '气死', '恼火'];
      
      // 统计关键词出现次数
      let happyCount = 0, anxiousCount = 0, sadCount = 0, angryCount = 0;
      
      happyKeywords.forEach(key => {
        if (content.includes(key)) happyCount++;
      });
      anxiousKeywords.forEach(key => {
        if (content.includes(key)) anxiousCount++;
      });
      sadKeywords.forEach(key => {
        if (content.includes(key)) sadCount++;
      });
      angryKeywords.forEach(key => {
        if (content.includes(key)) angryCount++;
      });
      
      // 根据关键词调整情绪数据（轻微调整，模拟真实分析）
      if (happyCount > 0) {
        emotionData.happy += happyCount * 5;
        emotionData.anxious -= happyCount * 2;
        emotionData.sad -= happyCount * 2;
      }
      if (anxiousCount > 0) {
        emotionData.anxious += anxiousCount * 8;
        emotionData.happy -= anxiousCount * 3;
      }
      if (sadCount > 0) {
        emotionData.sad += sadCount * 8;
        emotionData.happy -= sadCount * 3;
      }
      if (angryCount > 0) {
        emotionData.angry += angryCount * 5;
        emotionData.happy -= angryCount * 2;
      }
      
      // 修正数据范围（0-100）
      Object.keys(emotionData).forEach(key => {
        emotionData[key] = Math.max(0, Math.min(100, emotionData[key]));
      });
      
      // 重新计算总和并修正
      const total = emotionData.happy + emotionData.anxious + emotionData.sad + emotionData.angry;
      if (total !== 100) {
        const ratio = 100 / total;
        Object.keys(emotionData).forEach(key => {
          emotionData[key] = Math.round(emotionData[key] * ratio);
        });
      }
      
      // 更新情绪显示和建议
      updateEmotionDisplay();
      updateSuggestion();
    }

    // 新增：问答库展开/收起功能（全局函数）
    window.toggleAnswer = function(el) {
      const answerContent = el.nextElementSibling;
      const icon = el.querySelector('i');
      
      // 切换显示状态
      answerContent.classList.toggle('show');
      // 切换图标旋转
      icon.style.transform = answerContent.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0)';
    };
  </script>
</body>
</html>
