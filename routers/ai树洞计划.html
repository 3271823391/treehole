
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è½»è¯­ä¿¡ç®± - ç‰ˆæœ¬ä»‹ç»</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", "PingFang SC", sans-serif; }
        :root { --app-height: 100%; }
        body { background: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%); min-height: var(--app-height); color: #333; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px 0; }
        .header { text-align: center; margin: 40px 0 60px; }
        .header h1 { font-size: 2.8rem; margin-bottom: 20px; color: #5a67d8; }
        .header p { font-size: 1.2rem; color: #666; max-width: 800px; margin: 0 auto; line-height: 1.8; }
        .versions { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 30px; margin-bottom: 80px; align-items: stretch; }
        .version-card { background: #fff; border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); overflow: hidden; transition: transform .3s ease, box-shadow .3s ease; display: flex; flex-direction: column; }
        .version-card:hover { transform: translateY(-8px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12); }
        .version-tag { padding: 12px 0; text-align: center; font-weight: bold; font-size: 1.3rem; color: #fff; }
        .tag-normal { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .tag-allround { background: linear-gradient(90deg, #10b981, #34d399); }
        .tag-ip { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
        .version-content { padding: 30px 25px; display: flex; flex-direction: column; height: 100%; }
        .subtitle { font-size: 1.05rem; margin-bottom: 20px; color: #444; }
        .feature-list { list-style: none; }
        .feature-list li { padding: 12px 0; border-bottom: 1px solid #f0f0f0; display: flex; align-items: flex-start; line-height: 1.6; }
        .feature-list li:last-child { border-bottom: none; }
        .feature-list li::before { content: "âœ“"; color: #10b981; font-weight: bold; margin-right: 12px; font-size: 1.1rem; }
        .version-highlight { margin-top: 25px; padding: 15px; background-color: #f8f9fa; border-radius: 12px; border-left: 4px solid #5a67d8; }
        .version-highlight p { color: #555; font-size: .95rem; line-height: 1.7; }
        .action-btn { display: block; width: 100%; padding: 15px; margin-top: auto; text-align: center; background-color: #5a67d8; color: #fff; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color .2s ease; text-decoration: none; }
        .action-btn:hover { background-color: #4c51bf; }
        .ip-description { color: #555; line-height: 1.8; margin-bottom: 24px; white-space: pre-line; }
        .footer { text-align: center; color: #999; font-size: .9rem; margin-top: 60px; padding: 20px 0; }
        @media (max-width: 768px) { .header h1 { font-size: 2.2rem; } .header { margin: 20px 0 40px; } .versions { grid-template-columns: 1fr; gap: 20px; } .version-card { margin: 0 10px; } }
        .admin-console-link { position: fixed; top: 8px; right: 12px; opacity: 0.2; font-size: 14px; text-decoration: none; z-index: 99; }
        .menu-btn { position: fixed; top: 12px; left: 12px; z-index: 1200; background: #ffffff; color: #4c51bf; border: 1px solid #c7d2fe; border-radius: 8px; padding: 8px 12px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .menu-btn:hover { background: #eef2ff; }
        .drawer-mask { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.36); opacity: 0; pointer-events: none; transition: opacity .25s ease; z-index: 1198; }
        .profile-drawer { position: fixed; top: 0; left: 0; height: 100vh; width: min(38vw, 420px); min-width: 320px; background: #fff; box-shadow: 12px 0 24px rgba(0, 0, 0, 0.14); transform: translateX(-102%); transition: transform .28s ease; z-index: 1199; display: flex; flex-direction: column; padding: 20px 16px; gap: 14px; }
        .profile-drawer h3 { color: #374151; margin-bottom: 4px; }
        .drawer-user { display: flex; gap: 12px; align-items: center; padding: 8px 0; }
        .drawer-avatar-preview { width: 56px; height: 56px; border-radius: 999px; border: 1px solid #cbd5e1; object-fit: cover; background: #f8fafc; }
        .drawer-name { color: #111827; font-weight: 600; }
        .drawer-field { display: grid; gap: 6px; }
        .drawer-field label { color: #475569; font-size: 13px; }
        .drawer-input { width: 100%; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; font-size: 14px; }
        .drawer-btn { width: 100%; border: 1px solid #c7d2fe; background: #fff; color: #4c51bf; border-radius: 8px; padding: 10px; font-size: 14px; cursor: pointer; }
        .drawer-btn.primary { background: #4f46e5; color: #fff; border-color: #4f46e5; }
        .drawer-btn.danger { background: #fff5f5; color: #b91c1c; border-color: #fecaca; }
        .drawer-status { min-height: 20px; color: #64748b; font-size: 12px; }
        body.drawer-open { overflow: hidden; }
        body.drawer-open .drawer-mask { opacity: 1; pointer-events: auto; }
        body.drawer-open .profile-drawer { transform: translateX(0); }
        @media (max-width: 768px) {
            .profile-drawer { width: min(86vw, 420px); min-width: 0; }
        }
    </style>
</head>
<body>
    <button id="menuBtn" class="menu-btn" type="button" aria-label="æ‰“å¼€èœå•">èœå•</button>
    <div id="drawerMask" class="drawer-mask" aria-hidden="true"></div>
    <aside id="profileDrawer" class="profile-drawer" aria-hidden="true">
        <h3>èœå•</h3>
        <div class="drawer-user">
            <img id="drawerAvatarPreview" class="drawer-avatar-preview" src="/static/avatars/default.svg" alt="å¤´åƒé¢„è§ˆ">
            <div class="drawer-name" id="drawerNameDisplay">ç”¨æˆ·å</div>
        </div>
        <div class="drawer-field">
            <label for="drawerUsernameInput">ä¿®æ”¹ç”¨æˆ·å</label>
            <input id="drawerUsernameInput" class="drawer-input" type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            <button id="saveUsernameBtn" class="drawer-btn primary" type="button">ä¿®æ”¹ç”¨æˆ·å</button>
        </div>
        <div class="drawer-field">
            <label for="drawerAvatarInput">ä¿®æ”¹å¤´åƒ</label>
            <input id="drawerAvatarInput" type="file" accept="image/*">
            <button id="saveAvatarBtn" class="drawer-btn" type="button">ä¿®æ”¹å¤´åƒ</button>
        </div>
        <button id="drawerLogoutBtn" class="drawer-btn danger" type="button">é€€å‡ºç™»å½•</button>
        <div class="drawer-status" id="drawerStatus"></div>
    </aside>
    {{ADMIN_CONSOLE_LINK}}
    <div class="container">
        <div class="header">
            <h1>è½»è¯­ä¿¡ç®± - ç‰ˆæœ¬ä»‹ç»</h1>
            <p>å½“å‰ä»…æä¾›æ™®é€šç‰ˆä¸å…¨èƒ½ç‰ˆä¸¤ç§ä½“éªŒï¼Œä»¥åŠ 5 ä¸ªå›ºå®šé¢„è®¾çš„è™šæ‹Ÿ IP äº¤æµå…¥å£ã€‚</p>
        </div>

        <div class="versions">
            <div class="version-card">
                <div class="version-tag tag-normal">æ™®é€šç‰ˆ</div>
                <div class="version-content">
                    <p class="subtitle">æƒ…ç»ªé™ªä¼´ä¸æŒç»­äº¤æµ</p>
                    <ul class="feature-list">
                        <li>æƒ…ç»ªåŒ–å¯¹è¯ä¸é•¿æœŸä¸Šä¸‹æ–‡é™ªä¼´</li>
                        <li>å¤šè½®äº¤æµä¸­çš„æƒ…ç»ªç†è§£ä¸å›åº”</li>
                        <li>ä¸ªæ€§åŒ–çš„æƒ…ç»ªå¼•å¯¼ä¸å®‰æŠš</li>
                        <li>çº¯æ–‡æœ¬å½¢å¼çš„å®Œæ•´é™ªä¼´ä½“éªŒ</li>
                        <li>ç§å¯†ã€å®‰å…¨çš„å¯¹è¯ç¯å¢ƒ</li>
                    </ul>
                    <div class="version-highlight">
                        <p><strong>é€‚åˆäººç¾¤ï¼š</strong>å¸Œæœ›é€šè¿‡æ–‡å­—è·å¾—ç¨³å®šæƒ…ç»ªé™ªä¼´ä¸é•¿æœŸäº¤æµçš„ç”¨æˆ·</p>
                    </div>
                    <a href="/treehole_plus" class="action-btn">ç«‹å³ä½“éªŒ</a>
                </div>
            </div>

            <div class="version-card">
                <div class="version-tag tag-allround">å…¨èƒ½ç‰ˆ</div>
                <div class="version-content">
                    <p class="subtitle">è¯­éŸ³å…‹éš† Â· æ›´çœŸå®çš„é™ªä¼´ä½“éªŒ</p>
                    <ul class="feature-list">
                        <li>åŒ…å«æ™®é€šç‰ˆå…¨éƒ¨åŠŸèƒ½</li>
                        <li>ä¸“å±è¯­éŸ³å…‹éš†é™ªä¼´æœåŠ¡</li>
                        <li>ä½¿ç”¨å…‹éš†è¯­éŸ³è¿›è¡Œå®æ—¶å¯¹è¯</li>
                        <li>æ›´å…·æ²‰æµ¸æ„Ÿçš„æƒ…ç»ªäº¤æµä½“éªŒ</li>
                    </ul>
                    <div class="version-highlight">
                        <p><strong>é€‚åˆäººç¾¤ï¼š</strong>å¸Œæœ›é€šè¿‡è¯­éŸ³è·å¾—æ›´çœŸå®é™ªä¼´ä½“éªŒçš„ç”¨æˆ·</p>
                    </div>
                    <a href="/treehole_pro" class="action-btn">ç«‹å³ä½“éªŒ</a>
                </div>
            </div>

            <div class="version-card">
                <div class="version-tag tag-ip">è™šæ‹Ÿ IP</div>
                <div class="version-content">
                    <p class="ip-description">åœ¨è™šæ‹Ÿ IP ä¸­ï¼Œä½ å¯ä»¥é€‰æ‹©ä¸€ä¸ªé¢„è®¾è§’è‰²å¼€å§‹äº¤æµã€‚

å½“å‰æä¾› 5 ä¸ªä¸åŒçš„è§’è‰²é¢„è®¾ï¼Œ
æ¯ä¸ªè§’è‰²éƒ½æ‹¥æœ‰ç¨³å®šçš„æ€§æ ¼è®¾å®šä¸é•¿æœŸè®°å¿†ï¼Œ
äº¤æµæ–¹å¼ä¸å›åº”é£æ ¼å„ä¸ç›¸åŒã€‚

è§’è‰²ä¸å¯è‡ªå®šä¹‰ï¼Œ
ä½†ä½ å¯ä»¥åœ¨æŒç»­äº’åŠ¨ä¸­é€æ¸äº†è§£å¹¶å»ºç«‹å…³ç³»ã€‚</p>
                    <a href="/ip" class="action-btn">é€‰æ‹©è™šæ‹Ÿ IP</a>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>è½»è¯­ä¿¡ç®± Â© 2026 | ä½ çš„æƒ…ç»ªï¼Œå€¼å¾—è¢«è®¤çœŸå¯¹å¾… | ç‰ˆæƒæ‰€æœ‰-JSHTæ·æ€æ…§å›¾ç§‘æŠ€å…¬å¸</p>
        </div>
    </div>

    <script>
        const STORAGE_USERNAME_KEY = "treehole_username";
        const STORAGE_USER_ID_KEY = "treehole_user_id";
        const STORAGE_AVATAR_KEY = "treehole_avatar_url";
        const DEFAULT_AVATAR_URL = "/static/avatars/default.svg";

        const menuBtn = document.getElementById('menuBtn');
        const drawerMask = document.getElementById('drawerMask');
        const drawer = document.getElementById('profileDrawer');
        const drawerUsernameInput = document.getElementById('drawerUsernameInput');
        const saveUsernameBtn = document.getElementById('saveUsernameBtn');
        const drawerAvatarInput = document.getElementById('drawerAvatarInput');
        const saveAvatarBtn = document.getElementById('saveAvatarBtn');
        const drawerAvatarPreview = document.getElementById('drawerAvatarPreview');
        const drawerNameDisplay = document.getElementById('drawerNameDisplay');
        const drawerStatus = document.getElementById('drawerStatus');
        const drawerLogoutBtn = document.getElementById('drawerLogoutBtn');
        let pendingAvatarFile = null;

        function safeLocalStorageGet(key) {
            try { return localStorage.getItem(key); } catch (e) { return ''; }
        }

        function safeLocalStorageSet(key, value) {
            try { localStorage.setItem(key, value || ''); } catch (e) {}
        }

        function safeLocalStorageGetJson(key) {
            try {
                const raw = localStorage.getItem(key);
                return raw ? JSON.parse(raw) : null;
            } catch (e) {
                return null;
            }
        }

        function syncUserInfoToLocal(userInfo = {}) {
            const normalized = {
                username: (userInfo.username || '').trim(),
                user_id: (userInfo.user_id || '').trim(),
                avatar_url: (userInfo.avatar_url || '').trim() || DEFAULT_AVATAR_URL
            };
            const previous = safeLocalStorageGetJson('treehole_user') || {};
            const merged = {
                username: normalized.username || (previous.username || '').trim(),
                user_id: normalized.user_id || (previous.user_id || '').trim(),
                avatar_url: normalized.avatar_url || (previous.avatar_url || '').trim() || DEFAULT_AVATAR_URL
            };

            safeLocalStorageSet(STORAGE_USERNAME_KEY, merged.username);
            safeLocalStorageSet(STORAGE_USER_ID_KEY, merged.user_id);
            safeLocalStorageSet(STORAGE_AVATAR_KEY, merged.avatar_url);
            safeLocalStorageSet('treehole_user', JSON.stringify(merged));
            window.treeholeUser = merged;

            const nameSelectors = [
                '[data-user-name]',
                '.profile-name',
                '.drawer-name',
                '.user-info-name',
                '.user-card-title',
                '#userNameDisplay',
                '#drawerNameDisplay',
                '#mobile-user-card-title',
                '#mobileUserNameDisplay'
            ];
            const avatarSelectors = [
                '[data-user-avatar]',
                '.user-avatar',
                '.drawer-avatar-preview',
                '.user-info-avatar',
                '#user-avatar-img',
                '#mobile-avatar-img',
                '#drawerAvatarPreview'
            ];

            document.querySelectorAll(nameSelectors.join(',')).forEach((node) => {
                if (!merged.username) return;
                node.textContent = merged.username;
                node.title = merged.username;
            });
            document.querySelectorAll(avatarSelectors.join(',')).forEach((node) => {
                if (node.tagName === 'IMG') {
                    node.src = merged.avatar_url;
                    return;
                }
                node.style.backgroundImage = `url('${merged.avatar_url}')`;
            });

            window.dispatchEvent(new CustomEvent('treehole:user-updated', { detail: merged }));
            return merged;
        }

        async function sha1Hex(input) {
            const data = new TextEncoder().encode(input);
            const buffer = await crypto.subtle.digest('SHA-1', data);
            return Array.from(new Uint8Array(buffer)).map((b) => b.toString(16).padStart(2, '0')).join('');
        }

        async function makeUserId(username) {
            const norm = (username || '').trim().toLowerCase();
            if (!norm) return '';
            return `u_${await sha1Hex(norm)}`;
        }

        function openDrawer() {
            document.body.classList.add('drawer-open');
            drawer.setAttribute('aria-hidden', 'false');
            drawerMask.setAttribute('aria-hidden', 'false');
        }

        function closeDrawer() {
            document.body.classList.remove('drawer-open');
            drawer.setAttribute('aria-hidden', 'true');
            drawerMask.setAttribute('aria-hidden', 'true');
        }

        function renderDrawerIdentity() {
            const cached = safeLocalStorageGetJson('treehole_user') || {};
            const username = ((cached.username || safeLocalStorageGet(STORAGE_USERNAME_KEY)) || '').trim();
            const userId = ((cached.user_id || safeLocalStorageGet(STORAGE_USER_ID_KEY)) || '').trim();
            const avatarUrl = (cached.avatar_url || safeLocalStorageGet(STORAGE_AVATAR_KEY) || DEFAULT_AVATAR_URL).trim() || DEFAULT_AVATAR_URL;
            drawerUsernameInput.value = username;
            syncUserInfoToLocal({ username, user_id: userId, avatar_url: avatarUrl });
        }

        function setStatus(text, isError = false) {
            drawerStatus.textContent = text || '';
            drawerStatus.style.color = isError ? '#b91c1c' : '#64748b';
        }

        async function fetchJson(url, options = {}) {
            const res = await fetch(url, options);
            const contentType = res.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) return { ok: false, msg: 'æœåŠ¡æš‚ä¸å¯ç”¨' };
            const data = await res.json();
            if (!res.ok) return { ok: false, msg: data?.msg || 'æœåŠ¡æš‚ä¸å¯ç”¨' };
            return data;
        }

        async function saveUsername() {
            const username = drawerUsernameInput.value.trim();
            if (!username) {
                setStatus('ç”¨æˆ·åä¸èƒ½ä¸ºç©º', true);
                return;
            }

            const data = await fetchJson('/profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
            });

            if (!data?.ok) {
                setStatus(data?.msg || 'ç”¨æˆ·åä¿å­˜å¤±è´¥', true);
                return;
            }

            const profile = data.profile || {};
            syncUserInfoToLocal({
                username: profile.base_username || profile.username || username,
                user_id: profile.user_id || '',
                avatar_url: profile.base_avatar || profile.avatar_url || DEFAULT_AVATAR_URL
            });

            setStatus('ç”¨æˆ·åå·²æ›´æ–°');
        }

        async function saveAvatar() {
            if (!pendingAvatarFile) {
                setStatus('è¯·å…ˆé€‰æ‹©å¤´åƒæ–‡ä»¶', true);
                return;
            }
            const cachedUser = safeLocalStorageGetJson('treehole_user') || {};
            const username = drawerUsernameInput.value.trim() || (cachedUser.username || safeLocalStorageGet(STORAGE_USERNAME_KEY) || '').trim();
            if (!username) {
                setStatus('è¯·å…ˆè®¾ç½®ç”¨æˆ·å', true);
                return;
            }
            const userId = await makeUserId(username);

            const formData = new FormData();
            formData.append('file', pendingAvatarFile);
            formData.append('user_id', userId);
            const data = await fetchJson('/avatar_upload', { method: 'POST', body: formData });
            if (!data?.ok) {
                setStatus(data?.msg || 'å¤´åƒä¸Šä¼ å¤±è´¥', true);
                return;
            }
            const avatarUrl = data.avatar_url || DEFAULT_AVATAR_URL;
            syncUserInfoToLocal({
                username,
                user_id: userId,
                avatar_url: avatarUrl
            });
            pendingAvatarFile = null;
            drawerAvatarInput.value = '';
            setStatus('å¤´åƒå·²æ›´æ–°');
        }

        // å¤ç”¨åŸé€€å‡ºç™»å½•é€»è¾‘ï¼ˆåŸæœ¬ç­‰ä»·äºè®¿é—® /logoutï¼‰
        function performLogout() {
            window.location.href = '/logout';
        }import os
from datetime import datetime, timedelta, timezone

from fastapi import APIRouter, Request
from fastapi.responses import FileResponse, HTMLResponse, JSONResponse, RedirectResponse
from pydantic import BaseModel, ConfigDict, Field

from core.auth_utils import (
    is_valid_user_id,
    make_user_id,
    normalize_username,
    verify_password,
    hash_password,
    validate_password,
)
from data_store import load_user_data, save_user_data
router = APIRouter()

LOGIN_COOKIE_NAME = "auth_token"
REMEMBER_SECONDS = 7 * 24 * 60 * 60
SESSION_SECONDS = 12 * 60 * 60


class LoginRequest(BaseModel):
    model_config = ConfigDict(populate_by_name=True)

    user: str
    password: str = Field(alias="pass")
    remember: bool = False


class RegisterRequest(BaseModel):
    model_config = ConfigDict(populate_by_name=True)

    username: str = Field(alias="user")
    password: str = Field(alias="pass")


def _get_current_user_id(request: Request) -> str | None:
    user_id = request.cookies.get(LOGIN_COOKIE_NAME, "").strip()
    if not user_id:
        return None

    if not is_valid_user_id(user_id):
        return None

    user_info = load_user_data(user_id)
    if not user_info.get("profile", {}).get("password_hash"):
        return None
    return user_id


def _is_logged_in(request: Request) -> bool:
    return _get_current_user_id(request) is not None


def _require_login_redirect(request: Request):
    if not _is_logged_in(request):
        return RedirectResponse(url="/login", status_code=302)
    return None


def _render_html_file(filename: str) -> str:
    base_dir = os.path.dirname(__file__)
    html_path = os.path.join(base_dir, filename)
    with open(html_path, "r", encoding="utf-8") as f:
        return f.read()



def _with_admin_logger(html: str) -> str:
    script_tag = '<script src="/static/admin_console_logger.js"></script>'
    if script_tag in html:
        return html
    return html.replace("</body>", f"    {script_tag}\n</body>")


def _with_admin_link(html: str) -> str:
    show_link = os.getenv("SHOW_ADMIN_LINK", "1") == "1"
    return html.replace(
        "{{ADMIN_CONSOLE_LINK}}",
        '<a href="/static/admin_console.html" class="admin-console-link" onclick="window.location.href=\'/static/admin_console.html\'; return false;">ğŸ› </a>' if show_link else "",
    )

@router.get("/", response_class=HTMLResponse)
async def intro_page(request: Request):
    if _is_logged_in(request):
        return RedirectResponse(url="/aiæ ‘æ´è®¡åˆ’.html", status_code=302)
    return RedirectResponse(url="/login", status_code=302)


@router.get("/login", response_class=HTMLResponse)
async def login_page(request: Request):
    if _is_logged_in(request):
        return RedirectResponse(url="/aiæ ‘æ´è®¡åˆ’.html", status_code=302)
    return HTMLResponse(_render_html_file("login.html"))




@router.get("/register")
async def register_page(request: Request):
    if _is_logged_in(request):
        return RedirectResponse(url="/aiæ ‘æ´è®¡åˆ’.html", status_code=302)
    base_dir = os.path.dirname(os.path.dirname(__file__))
    return FileResponse(os.path.join(base_dir, "static", "register.html"))
@router.post("/register")
async def register_action(payload: RegisterRequest):
    username = (payload.username or "").strip()
    password = payload.password or ""

    norm = normalize_username(username)
    if not norm:
        return JSONResponse(status_code=400, content={"ok": False, "msg": "username_required"})

    valid_password, password_msg = validate_password(password)
    if not valid_password:
        return JSONResponse(status_code=400, content={"ok": False, "msg": password_msg})

    user_id = make_user_id(norm)
    user_info = load_user_data(user_id)
    profile = user_info.setdefault("profile", {})

    if profile.get("password_hash"):
        return JSONResponse(status_code=409, content={"ok": False, "msg": "user_already_exists"})

    profile["username"] = username
    profile.setdefault("display_name", "")
    profile.setdefault("avatar_url", "")
    profile["password_hash"] = hash_password(password)
    profile.pop("pin_hash", None)

    save_user_data(user_id, user_info)
    return JSONResponse(status_code=200, content={"ok": True, "user_id": user_id})


@router.post("/login")
async def login_action(payload: LoginRequest):
    user = (payload.user or "").strip()
    password = payload.password or ""

    norm = normalize_username(user)
    if not norm:
        return JSONResponse(status_code=400, content={"ok": False, "msg": "username_required"})

    user_id = make_user_id(norm)
    user_info = load_user_data(user_id)
    profile = user_info.get("profile", {})
    password_hash = profile.get("password_hash", "")

    if not password_hash:
        return JSONResponse(status_code=401, content={"ok": False, "msg": "invalid_credentials"})

    if not verify_password(password, password_hash):
        return JSONResponse(status_code=401, content={"ok": False, "msg": "invalid_credentials"})

    token_expire_seconds = REMEMBER_SECONDS if payload.remember else SESSION_SECONDS

    response = JSONResponse(status_code=200, content={"ok": True, "user_id": user_id})
    cookie_kwargs = {
        "key": LOGIN_COOKIE_NAME,
        "value": user_id,
        "httponly": True,
        "path": "/",
        "samesite": "lax",
    }

    if not payload.remember:
        cookie_kwargs["max_age"] = token_expire_seconds

    if payload.remember:
        expires_at = datetime.now(timezone.utc) + timedelta(seconds=REMEMBER_SECONDS)
        cookie_kwargs["max_age"] = REMEMBER_SECONDS
        cookie_kwargs["expires"] = expires_at.strftime("%a, %d %b %Y %H:%M:%S GMT")

    response.set_cookie(**cookie_kwargs)
    return response


@router.get("/logout")
async def logout_action():
    response = RedirectResponse(url="/login", status_code=302)
    response.delete_cookie(LOGIN_COOKIE_NAME, path="/")
    return response


@router.get("/aiæ ‘æ´è®¡åˆ’.html", response_class=HTMLResponse)
async def ai_treehole_page(request: Request):
    if not _is_logged_in(request):
        return RedirectResponse(url="/login", status_code=302)
    html = _render_html_file("aiæ ‘æ´è®¡åˆ’.html")
    return HTMLResponse(_with_admin_logger(_with_admin_link(html)))

@router.get("/ip", response_class=HTMLResponse)
async def ip_page(request: Request):
    unauthorized = _require_login_redirect(request)
    if unauthorized:
        return unauthorized
    base_dir = os.path.dirname(__file__)
    html_path = os.path.join(base_dir, "è™šæ‹Ÿip.html")

    with open(html_path, "r", encoding="utf-8") as f:
        return _with_admin_logger(f.read())

@router.get("/äºŒçº§é¡µé¢2ç¬¬å…­ç‰ˆ.html", response_class=HTMLResponse)
async def evolution_plus_page(request: Request):
    unauthorized = _require_login_redirect(request)
    if unauthorized:
        return unauthorized
    return render_html("äºŒçº§é¡µé¢2ç¬¬å…­ç‰ˆ.html")

@router.get("/page", response_class=HTMLResponse)
async def chat_page(request: Request):
    unauthorized = _require_login_redirect(request)
    if unauthorized:
        return unauthorized
    plan = request.query_params.get("plan", "plus")

    base_dir = os.path.dirname(__file__)
    html_path = os.path.join(base_dir, "treehole.html")

    with open(html_path, "r", encoding="utf-8") as f:
        html = f.read()

    html = html.replace("{{DEFAULT_PLAN}}", plan)
    return _with_admin_logger(html)


@router.get("/treehole_plus", response_class=HTMLResponse)
async def treehole_plus_page(request: Request):
    unauthorized = _require_login_redirect(request)
    if unauthorized:
        return unauthorized
    return render_html("treehole_plus.html")

@router.get("/treehole_pro", response_class=HTMLResponse)
async def treehole_pro_page(request: Request):
    unauthorized = _require_login_redirect(request)
    if unauthorized:
        return unauthorized
    return render_html("treehole_pro.html")

def render_html(filename: str):
    return _with_admin_logger(_render_html_file(filename))

def resolve_ip_user_id(request: Request) -> str:
    user_id = request.query_params.get("user_id", "")
    if is_valid_user_id(user_id):
        return user_id
    return make_user_id("web_user")


@router.get("/ip/linyu", response_class=HTMLResponse)
async def linyu_page(request: Request):
    unauthorized = _require_login_redirect(request)
    if unauthorized:
        return unauthorized
    user_id = resolve_ip_user_id(request)
    user_info = load_user_data(user_id)

    user_info["ip_name"] = "linyu"   # â˜… å¿…é¡»

    save_user_data(user_id, user_info)

    return HTMLResponse(_with_admin_logger(open("routers/æ—å±¿å“¥å“¥.html", encoding="utf-8").read()))



@router.get("/ip/suwan", response_class=HTMLResponse)
async def suwan_page(request: Request):
    unauthorized = _require_login_redirect(request)
    if unauthorized:
        return unauthorized
    user_id = resolve_ip_user_id(request)
    user_info = load_user_data(user_id)

    user_info["ip_name"] = "suwan"

    save_user_data(user_id, user_info)

    return HTMLResponse(_with_admin_logger(open("routers/è‹æ™šå§å§.html", encoding="utf-8").read()))


@router.get("/ip/xiaxingmian", response_class=HTMLResponse)
async def xiaxingmian_page(request: Request):
    unauthorized = _require_login_redirect(request)
    if unauthorized:
        return unauthorized
    user_id = resolve_ip_user_id(request)
    user_info = load_user_data(user_id)

    user_info["ip_name"] = "xiaxingmian"

    save_user_data(user_id, user_info)

    return HTMLResponse(_with_admin_logger(open("routers/ç—…å¨‡æ ¡èŠ±.html", encoding="utf-8").read()))

@router.get("/ip/jiangche", response_class=HTMLResponse)
async def jiangche_page(request: Request):
    unauthorized = _require_login_redirect(request)
    if unauthorized:
        return unauthorized
    user_id = resolve_ip_user_id(request)
    user_info = load_user_data(user_id)

    user_info["ip_name"] = "jiangche"

    save_user_data(user_id, user_info)

    return HTMLResponse(_with_admin_logger(open("routers/ç™½æœˆå…‰æ±Ÿæ¾ˆ.html", encoding="utf-8").read()))

@router.get("/ip/luchengyu", response_class=HTMLResponse)
async def luchengyu_page(request: Request):
    unauthorized = _require_login_redirect(request)
    if unauthorized:
        return unauthorized
    user_id = resolve_ip_user_id(request)
    user_info = load_user_data(user_id)

    user_info["ip_name"] = "luchengyu"

    save_user_data(user_id, user_info)

    return HTMLResponse(_with_admin_logger(open("routers/å­¦é•¿.html", encoding="utf-8").read()))


        function updateAppHeight() {
            const viewport = window.visualViewport;
            const height = viewport ? viewport.height : window.innerHeight;
            document.documentElement.style.setProperty('--app-height', `${height}px`);
        }
        updateAppHeight();
        window.addEventListener('resize', updateAppHeight);
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', updateAppHeight);
        }

        menuBtn.addEventListener('click', () => {
            renderDrawerIdentity();
            openDrawer();
        });
        drawerMask.addEventListener('click', closeDrawer);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeDrawer();
        });
        saveUsernameBtn.addEventListener('click', saveUsername);
        drawerAvatarInput.addEventListener('change', (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            pendingAvatarFile = file;
            drawerAvatarPreview.src = URL.createObjectURL(file);
            setStatus('å·²é€‰æ‹©æ–°å¤´åƒï¼Œç‚¹å‡»â€œä¿®æ”¹å¤´åƒâ€ä¿å­˜');
        });
        saveAvatarBtn.addEventListener('click', saveAvatar);
        drawerLogoutBtn.addEventListener('click', performLogout);
        renderDrawerIdentity();
    </script>
</body>
</html>
