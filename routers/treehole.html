<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒçµé¿é£æ¸¯ - å°ç›ˆé™ªä½ è¯´å¿ƒé‡Œè¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
        }

        body {
            background-color: #f0f7ff;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            padding-bottom: 40px; /* ä¸ºåº•éƒ¨ç‰ˆæƒé¢„ç•™ç©ºé—´ */
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  - ç§»é™¤AIæ ‘æ´ï¼Œç®€åŒ–æ–‡å­— */
        .header {
            background: linear-gradient(90deg, #4a90e2, #5ba0f2);
            color: #fff;
            padding: 1rem 2rem;
            text-align: center;
            box-shadow: 0 3px 15px rgba(74, 144, 226, 0.25);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.95;
            margin-top: 0.4rem;
        }

        /* ä¸»å®¹å™¨ - é‡æ„å¸ƒå±€ï¼ŒèŠå¤©æ¡†å ä¸»ä½“ */
        .main-container {
            flex: 1;
            display: flex;
            max-width: 1400px;
            margin: 1.2rem auto;
            padding: 0 1rem;
            gap: 1.2rem;
            flex-wrap: wrap;
        }

        /* èŠå¤©åŒºåŸŸ - æå‡å æ¯”ï¼Œä¸»ä½“è§†è§‰ */
        .chat-section {
            flex: 4; /* èŠå¤©åŒºå 4ä»½ï¼Œä¾§è¾¹æ å 1ä»½ï¼Œä¸»ä½“æ›´çªå‡º */
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* èŠå¤©çª—å£ - ä¼˜åŒ–å†…è¾¹è·å’Œé˜´å½± */
        .chat-window {
            flex: 1;
            background-color: #fff;
            border-radius: 16px;
            padding: 1.2rem 1.5rem;
            box-shadow: 0 0 25px rgba(74, 144, 226, 0.08);
            overflow-y: auto;
            min-height: 450px;
            max-height: 650px;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ–å‡çº§ */
        .chat-window::-webkit-scrollbar {
            width: 7px;
        }
        .chat-window::-webkit-scrollbar-thumb {
            background-color: #c1d9ff;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        .chat-window::-webkit-scrollbar-thumb:hover {
            background-color: #a3c1ff;
        }
        .chat-window::-webkit-scrollbar-track {
            background-color: #f8fbff;
        }

        /* æ¶ˆæ¯å®¹å™¨ - åŒ…å«å¤´åƒ+æ°”æ³¡ï¼Œå…³é”®å¸ƒå±€ */
        .msg-container {
            max-width: 80%;
            margin-bottom: 1.2rem;
            display: flex;
            align-items: flex-end;
            gap: 0.8rem;
        }

        /* å¤´åƒæ ·å¼ - åŒæ–¹ä¸“å±ï¼Œåœ†å½¢å¸¦è¾¹æ¡† */
        .msg-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border: 2px solid #f0f7ff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        /* ç”¨æˆ·å¤´åƒ - å³ä¾§æ¶ˆæ¯ï¼Œè“è‰²ç³» */
        .user-avatar {
            background-color: #4a90e2;
            color: #fff;
        }
        /* å°ç›ˆå¤´åƒ - å·¦ä¾§æ¶ˆæ¯ï¼Œæµ…è“ç³» */
        .ai-avatar {
            background-color: #e8f4ff;
            color: #4a90e2;
        }

        /* æ¶ˆæ¯æ°”æ³¡é€šç”¨ - ä¼˜åŒ–å†…è¾¹è·å’Œåœ†è§’ */
        .message {
            padding: 0.9rem 1.3rem;
            border-radius: 20px;
            line-height: 1.6;
            font-size: 0.95rem;
            position: relative;
            word-wrap: break-word;
        }

        /* ç”¨æˆ·æ¶ˆæ¯ - å³å¯¹é½ï¼Œè“è‰²æ°”æ³¡ï¼Œå¤´åƒåœ¨å³ */
        .user-msg-wrap {
            margin-left: auto;
            flex-direction: row-reverse; /* å¤´åƒåœ¨æ°”æ³¡å³ä¾§ */
        }
        .user-msg {
            background-color: #4a90e2;
            color: #fff;
            border-bottom-right-radius: 6px;
        }

        /* å°ç›ˆæ¶ˆæ¯ - å·¦å¯¹é½ï¼Œæµ…è“æ°”æ³¡ï¼Œå¤´åƒåœ¨å·¦ */
        .ai-msg-wrap {
            margin-right: auto;
        }
        .ai-msg {
            background-color: #e8f4ff;
            color: #333;
            border-bottom-left-radius: 6px;
        }

        /* åŠ è½½åŠ¨ç”» - é€‚é…å¤´åƒå¸ƒå±€ */
        .loading-wrap {
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        .loading {
            display: flex;
            gap: 4px;
            padding: 0.9rem 1rem;
            background-color: #e8f4ff;
            border-radius: 20px;
            border-bottom-left-radius: 6px;
        }
        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4a90e2;
            animation: bounce 1s infinite alternate;
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-6px); }
        }

        /* è¾“å…¥æ¡†åŒºåŸŸ - ä¼˜åŒ–åœ†è§’å’Œé˜´å½± */
        .input-area {
            display: flex;
            gap: 0.8rem;
            align-items: center;
            background-color: #fff;
            padding: 0.9rem 1.4rem;
            border-radius: 36px;
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.08);
        }

        #msg-input {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 0.95rem;
            color: #333;
            resize: none;
            min-height: 20px;
            max-height: 120px;
            overflow-y: auto;
            padding: 0.3rem 0;
        }

        #msg-input::placeholder {
            color: #b0c4de;
        }

        .send-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background-color: #4a90e2;
            color: #fff;
            border: none;
            outline: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }

        .send-btn:disabled {
            background-color: #d0e1ff;
            cursor: not-allowed;
            box-shadow: none;
        }

        .send-btn:hover:not(:disabled) {
            background-color: #357bd8;
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(74, 144, 226, 0.4);
        }

        /* ä¾§è¾¹æ  - æ”¶çª„å®½åº¦ï¼Œè¾…åŠ©å¸ƒå±€ */
        .sidebar {
            flex: 1; /* ä¸èŠå¤©åŒº4:1æ¯”ä¾‹ï¼Œæ›´ç´§å‡‘ */
            min-width: 280px;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        .user-card {
            background-color: #fff;
            border-radius: 16px;
            padding: 1.4rem;
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.08);
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
        }

        .user-card-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .user-card-title {
            font-weight: 600;
            font-size: 1rem;
            color: #3b6fb6;
        }

        .user-avatar-box {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #e1ecff;
            flex-shrink: 0;
            cursor: pointer;
            background-color: #f0f7ff;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-avatar-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-card .form-row {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .user-card label {
            font-size: 0.82rem;
            color: #6b7c93;
        }

        .user-card input {
            border: 1px solid #d6e3f8;
            border-radius: 10px;
            padding: 0.55rem 0.7rem;
            font-size: 0.9rem;
        }

        .user-card input:disabled {
            background-color: #f5f7fb;
            color: #9aa9bf;
        }

        .user-card-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .user-card button {
            border: none;
            border-radius: 10px;
            padding: 0.55rem 0.8rem;
            font-size: 0.85rem;
            cursor: pointer;
            background-color: #4a90e2;
            color: #fff;
            transition: background-color 0.2s ease;
        }

        .user-card button.secondary {
            background-color: #e8f1ff;
            color: #3b6fb6;
        }

        .user-card button:disabled {
            background-color: #cbd9f0;
            cursor: not-allowed;
        }

        .lock-status {
            font-size: 0.82rem;
            color: #d9534f;
        }

        /* å°ç›ˆå½¢è±¡å¡ç‰‡ - ä¼˜åŒ–æ¸å˜å’Œé˜´å½± */
        .ai-card {
            background: linear-gradient(135deg, #e8f4ff, #d0e1ff);
            border-radius: 20px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.12);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .ai-card-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background-color: #fff;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            color: #4a90e2;
            border: 4px solid #4a90e2;
            box-shadow: 0 3px 10px rgba(74, 144, 226, 0.2);
        }

        .ai-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #4a90e2;
            margin-bottom: 0.6rem;
            letter-spacing: 0.5px;
        }

        .ai-desc {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.5;
        }

        /* æƒ…ç»ªåˆ†ææŠ¥å‘Šæ¨¡å— - ä¼˜åŒ–å†…è¾¹è·å’Œåœ†è§’ */
        .emotion-report {
            background-color: #fff;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.08);
            flex: 1;
            border: 1px solid rgba(240,247,255,0.8);
        }

        .report-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: #4a90e2;
            margin-bottom: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .report-title i {
            font-size: 1.3rem;
        }

        /* æƒ…ç»ªæŒ‡æ•°è¿›åº¦æ¡ - ä¼˜åŒ–æ ·å¼ */
        .emotion-score {
            margin-bottom: 1.5rem;
        }

        .score-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.6rem;
        }

        .score-bar {
            width: 100%;
            height: 10px;
            background-color: #f0f5ff;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff8a8a, #4a90e2);
            border-radius: 5px;
            width: 60%;
            transition: width 0.8s ease-in-out;
            box-shadow: 0 0 5px rgba(74, 144, 226, 0.3);
        }

        /* æƒ…ç»ªæ ‡ç­¾ - ä¼˜åŒ–åœ†è§’å’Œé…è‰² */
        .emotion-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            margin-bottom: 1.5rem;
        }

        .emotion-tag {
            padding: 0.4rem 1rem;
            background-color: #e8f4ff;
            color: #4a90e2;
            border-radius: 24px;
            font-size: 0.85rem;
            border: 1px solid #d0e1ff;
        }

        /* åˆ†æå’Œå»ºè®® - ä¼˜åŒ–è¡Œé«˜ */
        .emotion-analysis, .emotion-suggest {
            margin-bottom: 1.2rem;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .analysis-label, .suggest-label {
            font-weight: 700;
            color: #4a90e2;
            margin-bottom: 0.4rem;
            display: block;
        }

        /* ç©ºçŠ¶æ€æç¤º - ä¼˜åŒ–æ ·å¼ */
        .empty-tip {
            text-align: center;
            color: #999;
            font-size: 1rem;
            padding: 4rem 0;
            line-height: 1.8;
        }

        .empty-tip i {
            font-size: 2.5rem;
            margin-bottom: 0.8rem;
            display: block;
            color: #c1d9ff;
        }

        /* åº•éƒ¨ç‰ˆæƒ - å›ºå®šåº•éƒ¨ï¼Œå°å­—æ ‡æ˜ */
        .copyright {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            color: #999;
            border-top: 1px solid #f0f7ff;
            z-index: 90;
        }

        /* å“åº”å¼é€‚é… - å…¨å°ºå¯¸å…¼å®¹ */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                margin: 0.8rem auto;
                gap: 1rem;
            }

            .sidebar {
                width: 100%;
                min-width: unset;
            }

            .chat-window {
                min-height: 350px;
                max-height: 500px;
                padding: 1rem 1.2rem;
            }

            .msg-container {
                max-width: 85%;
                gap: 0.6rem;
            }

            .msg-avatar {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }

            .message {
                padding: 0.8rem 1.2rem;
                font-size: 0.9rem;
            }

            .header h1 {
                font-size: 1.4rem;
            }

            .ai-card-avatar {
                width: 80px;
                height: 80px;
                font-size: 2rem;
            }

            .copyright {
                font-size: 0.8rem;
                padding: 0 1rem;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .msg-container {
                max-width: 90%;
            }

            .input-area {
                padding: 0.8rem 1.2rem;
            }

            .send-btn {
                width: 36px;
                height: 36px;
            }
        }
    </style>
    <!-- å¼•å…¥å­—ä½“å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  - ç§»é™¤AIæ ‘æ´æ–‡å­— -->
    <header class="header">
        <h1>å¿ƒçµé¿é£æ¸¯</h1>
        <p>å°ç›ˆé™ªä½ å€¾è¯‰æ‰€æœ‰å¿ƒäº‹ï¼Œåšä½ æœ€æ¸©æš–çš„å€¾å¬è€…</p>
    </header>

    <!-- ä¸»å®¹å™¨ - èŠå¤©æ¡†å ä¸»ä½“ -->
    <main class="main-container">
        <!-- èŠå¤©åŒºåŸŸ - ä¸»ä½“å æ¯” -->
        <section class="chat-section">
            <!-- èŠå¤©çª—å£ - æ˜¾ç¤ºåŒæ–¹å¤´åƒ -->
            <div class="chat-window" id="chat-window">
                <div class="empty-tip" id="empty-tip">
                    <i class="fas fa-comments"></i>
                    ä½ å¥½å‘€ï½æˆ‘æ˜¯å°ç›ˆ ğŸ˜Š<br>
                    æœ‰ä»€ä¹ˆå¿ƒäº‹æƒ³å’Œæˆ‘è¯´å—ï¼Ÿæˆ‘ä¼šè®¤çœŸå€¾å¬çš„
                </div>
            </div>

            <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
            <div class="input-area">
                <textarea id="msg-input" placeholder="è¾“å…¥æƒ³å€¾è¯‰çš„å†…å®¹ï¼ŒæŒ‰å›è½¦å‘é€..." rows="1"></textarea>
                <button class="send-btn" id="send-btn" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </section>

        <!-- ä¾§è¾¹æ ï¼šç”¨æˆ·å¡ç‰‡ + å°ç›ˆå½¢è±¡ + æƒ…ç»ªåˆ†ææŠ¥å‘Šï¼ˆè¾…åŠ©å¸ƒå±€ï¼‰ -->
        <aside class="sidebar">
            <div class="user-card">
                <div class="user-card-header">
                    <div class="user-avatar-box" id="user-avatar-box">
                        <img src="/static/avatars/default.svg" alt="ç”¨æˆ·å¤´åƒ" id="user-avatar-img">
                    </div>
                    <div>
                        <div class="user-card-title">ç”¨æˆ·ä¸­å¿ƒ</div>
                        <div class="lock-status" id="lock-status">è¯·å…ˆè¾“å…¥ç”¨æˆ·åä¸ PIN è§£é”</div>
                    </div>
                </div>

                <input type="file" id="avatar-input" accept="image/*" hidden>

                <div class="form-row">
                    <label for="login-username">ç”¨æˆ·å</label>
                    <input id="login-username" type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>

                <div class="form-row">
                    <label for="pin-input">PINï¼ˆ4-6ä½æ•°å­—ï¼‰</label>
                    <input id="pin-input" type="password" inputmode="numeric" maxlength="6" placeholder="è¾“å…¥PIN">
                </div>

                <div class="user-card-actions">
                    <button id="unlock-btn">è¿›å…¥/è§£é”</button>
                    <button id="init-btn" class="secondary" style="display:none;">é¦–æ¬¡è®¾ç½®</button>
                </div>

                <div class="form-row">
                    <label for="display-username">æ˜¾ç¤ºåç§°</label>
                    <input id="display-username" type="text" placeholder="è§£é”åå¯ç¼–è¾‘" disabled>
                </div>

                <div class="user-card-actions">
                    <button id="save-profile-btn" class="secondary" disabled>ä¿å­˜åç§°</button>
                    <button id="upload-avatar-btn" class="secondary" disabled>ä¸Šä¼ å¤´åƒ</button>
                </div>
            </div>

            <!-- å°ç›ˆå½¢è±¡å¡ç‰‡ -->
            <div class="ai-card">
                <div class="ai-card-avatar">
                    <i class="fas fa-girl"></i>
                </div>
                <h3 class="ai-name">å°ç›ˆ</h3>
                <p class="ai-desc">ä½ çš„ä¸“å±å¿ƒçµå€¾å¬è€…<br>æ¸©æŸ”Â·è€å¿ƒÂ·ä¿å¯†<br>é™ªä½ åº¦è¿‡æ¯ä¸€ä¸ªæƒ…ç»ªæ—¶åˆ»</p>
            </div>

            <!-- æƒ…ç»ªåˆ†ææŠ¥å‘Š -->
            <div class="emotion-report">
                <h3 class="report-title">
                    <i class="fas fa-chart-line"></i>
                    æƒ…ç»ªåˆ†ææŠ¥å‘Š
                </h3>
                <div class="emotion-score">
                    <div class="score-label">
                        <span>æƒ…ç»ªæŒ‡æ•°</span>
                        <span id="emotion-score-num">60</span>/100
                    </div>
                    <div class="score-bar">
                        <div class="score-fill" id="score-fill"></div>
                    </div>
                </div>
                <div class="emotion-tags" id="emotion-tags">
                    <span class="emotion-tag">å¹³é™</span>
                    <span class="emotion-tag">æœŸå¾…</span>
                </div>
                <div class="emotion-analysis">
                    <span class="analysis-label">æƒ…ç»ªåˆ†æï¼š</span>
                    <span id="emotion-analysis">å½“å‰æœªæ£€æµ‹åˆ°æ˜æ˜¾çš„è´Ÿé¢æƒ…ç»ªï¼Œå¿ƒæ€å¤„äºå¹³å’Œçš„çŠ¶æ€ï¼Œå¯¹äº¤æµæŠ±æœ‰è½»å¾®æœŸå¾…ã€‚</span>
                </div>
                <div class="emotion-suggest">
                    <span class="suggest-label">æš–å¿ƒå»ºè®®ï¼š</span>
                    <span id="emotion-suggest">ä¿æŒè¿™ä»½å¹³å’Œçš„å¿ƒæƒ…ï¼Œå¤§èƒ†è¯´å‡ºä½ çš„æƒ³æ³•å§ï¼Œæˆ‘ä¼šä¸€ç›´åœ¨è¿™é‡Œé™ªç€ä½ ï½</span>
                </div>
            </div>
        </aside>
    </main>

    <!-- åº•éƒ¨ç‰ˆæƒ - å›ºå®šåº•éƒ¨ï¼Œå°å­—æ ‡æ˜ -->
    <div class="copyright">
        ç‰ˆæƒæ‰€æœ‰-JSHTæ·æ€æ…§å›¾ç§‘æŠ€ ç¿»ç‰ˆå¿…ç©¶
    </div>

    <script>
        const STORAGE_USERNAME_KEY = "treehole_username";
        const STORAGE_TOKEN_KEY = "treehole_token";
        let currentUserId = null;
        let authToken = sessionStorage.getItem(STORAGE_TOKEN_KEY) || "";
        let isUnlocked = false;
        const chatHistory = [];
        let emotionLocked = false;
        let emotionDebounceTimer = null;
        // âœ…ã€æ–°å¢ï¼šæƒ…ç»ªåˆ†æè½®æ¬¡æ§åˆ¶ã€‘
        let currentRound = 0;
        let lastEmotionRound = -1;
        const EMOTION_DEBOUNCE_MS = 450;
        const EMOTION_HISTORY_LIMIT = 24;

        async function fetchJson(url, options = {}) {
            const res = await fetch(url, options);
            const contentType = res.headers.get("content-type") || "";
            if (!contentType.includes("application/json")) {
                const text = await res.text();
                return { ok: false, msg: "æœåŠ¡æš‚ä¸å¯ç”¨", status: res.status, raw: text };
            }
            try {
                const data = await res.json();
                return data;
            } catch (e) {
                return { ok: false, msg: "æœåŠ¡æš‚ä¸å¯ç”¨" };
            }
        }

        function getAuthHeaders() {
            if (!authToken) return {};
            return { Authorization: `Bearer ${authToken}` };
        }

        function setUnlockedState(unlocked) {
            isUnlocked = unlocked;
            msgInput.disabled = !unlocked;
            sendBtn.disabled = !unlocked || msgInput.value.trim() === "";
            displayUsernameInput.disabled = !unlocked;
            saveProfileBtn.disabled = !unlocked;
            uploadAvatarBtn.disabled = !unlocked;
            if (unlocked) {
                lockStatus.innerText = "å·²è§£é”ï¼Œå¯å¼€å§‹èŠå¤©";
                lockStatus.style.color = "#3b6fb6";
                initBtn.style.display = "none";
            } else {
                lockStatus.innerText = "è¯·å…ˆè¾“å…¥ç”¨æˆ·åä¸ PIN è§£é”";
                lockStatus.style.color = "#d9534f";
            }
        }

        function updateAvatar(url) {
            if (url) {
                userAvatarImg.src = url;
            } else {
                userAvatarImg.src = "/static/avatars/default.svg";
            }
        }

        async function safeParseEmotionResponse(res) {
            const contentType = res.headers.get("content-type") || "";
            const cloned = res.clone();
            if (!res.ok) {
                const text = await cloned.text();
                console.warn("æƒ…ç»ªåˆ†æå“åº”é 200", res.status, text);
                return null;
            }
            if (!contentType.includes("application/json")) {
                const text = await cloned.text();
                console.warn("æƒ…ç»ªåˆ†æå“åº”é JSON", text);
                return null;
            }
            try {
                return await res.json();
            } catch (e) {
                const text = await cloned.text();
                console.warn("æƒ…ç»ªåˆ†æ JSON è§£æå¤±è´¥", e, text);
                return null;
            }
        }
        function buildEmotionHistory(roundId, currentInput) {
            const filtered = chatHistory.filter((item) => {
                if (!item || typeof item !== "object") return false;
                if (item.round_id == null) return true;
                return item.round_id < roundId;
            });
            if (filtered.length && filtered[filtered.length - 1]?.role === "user"
                && filtered[filtered.length - 1]?.content === currentInput) {
                filtered.pop();
            }
            if (filtered.length > EMOTION_HISTORY_LIMIT) {
                return filtered.slice(-EMOTION_HISTORY_LIMIT);
            }
            return filtered;
        }

        function scheduleEmotionUpdate(content) {
            if (emotionDebounceTimer) {
                clearTimeout(emotionDebounceTimer);
            }
            emotionDebounceTimer = setTimeout(() => {
                updateEmotionOnce(content);
            }, EMOTION_DEBOUNCE_MS);
        }

        async function updateEmotionOnce(content) {
            // âœ… åŒä¸€è½®å¯¹è¯åªå…è®¸åˆ†æä¸€æ¬¡
            if (emotionLocked || lastEmotionRound === currentRound) return;
            if (!isUnlocked || !currentUserId) return;

            emotionLocked = true;
            lastEmotionRound = currentRound;

            const history = buildEmotionHistory(currentRound, content);

            try {
                const res = await fetch("/emotion", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", ...getAuthHeaders() },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        history,
                        current_input: content,
                        round_id: currentRound
                    })

                });

                const payload = await safeParseEmotionResponse(res);
                if (!payload || !payload.ok || !payload.data) {
                    emotionAnalysis.innerText = "æƒ…ç»ªåˆ†ææš‚ä¸å¯ç”¨";
                    emotionSuggest.innerText = "å½“å‰æƒ…ç»ªåˆ†ææœåŠ¡ä¸å¯ç”¨ï¼Œç¨åå†è¯•ã€‚";
                    return;
                }
                const data = payload.data;

                // æƒ…ç»ªåˆ†æ•°
                emotionScoreNum.innerText = data.score;
                scoreFill.style.width = data.score + "%";

                // æƒ…ç»ªæ ‡ç­¾
                emotionTags.innerHTML = "";
                if (Array.isArray(data.tags)) {
                    data.tags.forEach(tag => {
                        const span = document.createElement("span");
                        span.className = "emotion-tag";
                        span.innerText = tag;
                        emotionTags.appendChild(span);
                    });
                }

                // åˆ†æ & å»ºè®®
                emotionAnalysis.innerText = data.analysis;
                emotionSuggest.innerText = data.suggestion;

            } catch (e) {
                console.error("æƒ…ç»ªåˆ†æå¤±è´¥", e);
            } finally {
                emotionLocked = false;
            }
        }

        // è·å–DOMå…ƒç´ 
        const chatWindow = document.getElementById('chat-window');
        const msgInput = document.getElementById('msg-input');
        const sendBtn = document.getElementById('send-btn');
        const emptyTip = document.getElementById('empty-tip');
        const emotionScoreNum = document.getElementById('emotion-score-num');
        const scoreFill = document.getElementById('score-fill');
        const emotionTags = document.getElementById('emotion-tags');
        const emotionAnalysis = document.getElementById('emotion-analysis');
        const emotionSuggest = document.getElementById('emotion-suggest');
        const loginUsernameInput = document.getElementById('login-username');
        const pinInput = document.getElementById('pin-input');
        const unlockBtn = document.getElementById('unlock-btn');
        const initBtn = document.getElementById('init-btn');
        const displayUsernameInput = document.getElementById('display-username');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const uploadAvatarBtn = document.getElementById('upload-avatar-btn');
        const avatarInput = document.getElementById('avatar-input');
        const userAvatarBox = document.getElementById('user-avatar-box');
        const userAvatarImg = document.getElementById('user-avatar-img');
        const lockStatus = document.getElementById('lock-status');

        function clearChatWindow() {
            chatWindow.innerHTML = "";
            emptyTip.style.display = 'block';
        }

        function renderHistory(history) {
            clearChatWindow();
            if (!Array.isArray(history) || history.length === 0) {
                return;
            }
            emptyTip.style.display = 'none';
            history.forEach((item) => {
                if (!item || !item.role || !item.content) return;
                addMessage(item.content, item.role === "user" ? "user" : "ai");
            });
        }

        async function loadHistory() {
            if (!currentUserId) return;
            const data = await fetchJson(`/load_history?user_id=${encodeURIComponent(currentUserId)}`, {
                headers: { ...getAuthHeaders() }
            });
            if (!data || !data.ok) {
                return;
            }
            chatHistory.length = 0;
            data.history.forEach((item) => chatHistory.push(item));
            renderHistory(data.history);
        }

        async function loadProfile() {
            const data = await fetchJson("/profile", {
                headers: { ...getAuthHeaders() }
            });
            if (!data || !data.ok) {
                return false;
            }
            currentUserId = data.user_id;
            displayUsernameInput.value = data.profile?.username || "";
            updateAvatar(data.profile?.avatar_url);
            setUnlockedState(true);
            await loadHistory();
            return true;
        }

        async function handleVerify() {
            const username = loginUsernameInput.value.trim();
            const pin = pinInput.value.trim();
            if (!username) {
                lockStatus.innerText = "è¯·è¾“å…¥ç”¨æˆ·å";
                lockStatus.style.color = "#d9534f";
                return;
            }
            const data = await fetchJson("/auth/verify", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, pin })
            });
            if (!data || !data.ok) {
                if (data?.need_init) {
                    lockStatus.innerText = "è¯¥ç”¨æˆ·åæœªè®¾ç½® PINï¼Œè¯·å…ˆåˆå§‹åŒ–";
                    lockStatus.style.color = "#d9534f";
                    initBtn.style.display = "inline-flex";
                } else if (data?.locked) {
                    lockStatus.innerText = `å·²é”å®šï¼Œè¯· ${data.seconds_left}s åå†è¯•`;
                    lockStatus.style.color = "#d9534f";
                } else {
                    lockStatus.innerText = "PIN é”™è¯¯æˆ–éªŒè¯å¤±è´¥";
                    lockStatus.style.color = "#d9534f";
                }
                return;
            }

            authToken = data.token;
            sessionStorage.setItem(STORAGE_TOKEN_KEY, authToken);
            localStorage.setItem(STORAGE_USERNAME_KEY, username);
            currentUserId = data.user_id;
            displayUsernameInput.value = data.profile?.username || username;
            updateAvatar(data.profile?.avatar_url);
            setUnlockedState(true);
            await loadHistory();
        }

        async function handleInit() {
            const username = loginUsernameInput.value.trim();
            const pin = pinInput.value.trim();
            if (!username || !pin) {
                lockStatus.innerText = "è¯·è¾“å…¥ç”¨æˆ·åä¸ PIN";
                lockStatus.style.color = "#d9534f";
                return;
            }
            const data = await fetchJson("/auth/init", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, pin })
            });
            if (!data || !data.ok) {
                lockStatus.innerText = "åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ PIN";
                lockStatus.style.color = "#d9534f";
                return;
            }
            await handleVerify();
        }

        async function saveProfile() {
            const username = displayUsernameInput.value.trim();
            if (!username) {
                lockStatus.innerText = "æ˜¾ç¤ºåç§°ä¸èƒ½ä¸ºç©º";
                lockStatus.style.color = "#d9534f";
                return;
            }
            const data = await fetchJson("/profile", {
                method: "POST",
                headers: { "Content-Type": "application/json", ...getAuthHeaders() },
                body: JSON.stringify({ username })
            });
            if (data?.ok) {
                lockStatus.innerText = "åç§°å·²æ›´æ–°";
                lockStatus.style.color = "#3b6fb6";
            } else {
                lockStatus.innerText = "åç§°ä¿å­˜å¤±è´¥";
                lockStatus.style.color = "#d9534f";
            }
        }

        async function uploadAvatar(file) {
            if (!file || !currentUserId) return;
            const formData = new FormData();
            formData.append("file", file);
            formData.append("user_id", currentUserId);

            const data = await fetchJson("/avatar_upload", {
                method: "POST",
                headers: { ...getAuthHeaders() },
                body: formData
            });
            if (data?.ok) {
                updateAvatar(data.avatar_url);
                lockStatus.innerText = "å¤´åƒå·²æ›´æ–°";
                lockStatus.style.color = "#3b6fb6";
            } else {
                lockStatus.innerText = "å¤´åƒä¸Šä¼ å¤±è´¥";
                lockStatus.style.color = "#d9534f";
            }
        }

        unlockBtn.addEventListener('click', handleVerify);
        initBtn.addEventListener('click', handleInit);
        saveProfileBtn.addEventListener('click', saveProfile);
        uploadAvatarBtn.addEventListener('click', () => avatarInput.click());
        userAvatarBox.addEventListener('click', () => {
            if (!isUnlocked) return;
            avatarInput.click();
        });
        avatarInput.addEventListener('change', (e) => {
            const file = e.target.files?.[0];
            if (file) {
                uploadAvatar(file);
            }
        });

        const lastUsername = localStorage.getItem(STORAGE_USERNAME_KEY);
        if (lastUsername) {
            loginUsernameInput.value = lastUsername;
        }

        if (authToken) {
            loadProfile().then((ok) => {
                if (!ok) {
                    sessionStorage.removeItem(STORAGE_TOKEN_KEY);
                    authToken = "";
                    setUnlockedState(false);
                }
            }).catch(() => {
                sessionStorage.removeItem(STORAGE_TOKEN_KEY);
                authToken = "";
                setUnlockedState(false);
            });
        } else {
            setUnlockedState(false);
        }

        // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–ï¼Œæ§åˆ¶å‘é€æŒ‰é’®çŠ¶æ€+è‡ªé€‚åº”é«˜åº¦
        msgInput.addEventListener('input', () => {
            const content = msgInput.value.trim();
            sendBtn.disabled = !isUnlocked || content === '';
            // è‡ªé€‚åº”è¾“å…¥æ¡†é«˜åº¦
            msgInput.style.height = 'auto';
            msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + 'px';
        });

        // å›è½¦å‘é€ï¼ˆæŒ‰ä½shift+å›è½¦æ¢è¡Œï¼‰
        msgInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // ç‚¹å‡»å‘é€æŒ‰é’®
        sendBtn.addEventListener('click', sendMessage);

        async function sendMessage() {
        if (!isUnlocked || !currentUserId) {
            lockStatus.innerText = "è¯·å…ˆè§£é”è´¦å·";
            lockStatus.style.color = "#d9534f";
            return;
        }
        const content = msgInput.value.trim();
        if (!content) return;

        // âœ…ã€æ–°å¢ï¼šå¼€å¯æ–°ä¸€è½®å¯¹è¯ã€‘
        currentRound++;


        // ç”¨æˆ·æ¶ˆæ¯
            addMessage(content, 'user');
            scheduleEmotionUpdate(content);
            chatHistory.push({
                role: "user",
                content: content,
                round_id: currentRound
            });
        // ç„¶åæ›´æ–° UI
        msgInput.value = '';
        msgInput.style.height = 'auto';
        sendBtn.disabled = true;
        emptyTip.style.display = 'none';

        // åˆ›å»º AI æ¶ˆæ¯æ°”æ³¡ï¼ˆç©ºçš„ï¼Œç”¨æ¥æµï¼‰
        const aiWrap = document.createElement('div');
        aiWrap.className = 'msg-container ai-msg-wrap';

        const avatar = document.createElement('div');
        avatar.className = 'msg-avatar ai-avatar';
        avatar.innerHTML = '<i class="fas fa-girl"></i>';

        const aiMsg = document.createElement('div');
        aiMsg.className = 'message ai-msg';
        aiMsg.innerText = '';

        aiWrap.appendChild(avatar);
        aiWrap.appendChild(aiMsg);
        chatWindow.appendChild(aiWrap);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        showLoading();

        try {
            const resp = await fetch("/chat_stream", {
                method: "POST",
                headers: { "Content-Type": "application/json", ...getAuthHeaders() },
                body: JSON.stringify({
                    user_id: currentUserId,   // â† å¿…é¡»æœ‰
                    history: chatHistory,
                    user_input: content,
                    round_id: currentRound
                })

            });
            const contentType = resp.headers.get("content-type") || "";
            if (!resp.ok || contentType.includes("application/json")) {
                const payload = await safeParseEmotionResponse(resp);
                removeLoading();
                aiMsg.innerText = payload?.msg || "æœåŠ¡æš‚ä¸å¯ç”¨";
                return;
            }
            removeLoading();

            const reader = resp.body.getReader();
            const decoder = new TextDecoder("utf-8");

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                aiMsg.innerText += decoder.decode(value);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
            chatHistory.push({
                role: "assistant",
                content: aiMsg.innerText,
                round_id: currentRound
            });
        }
            catch (err) {
                removeLoading();
                aiMsg.innerText = "ï¼ˆè¿æ¥å¤±è´¥äº†ï¼Œå°ç›ˆæ²¡æ¥ä¸Šä½  ğŸ˜”ï¼‰";
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£ï¼ˆæ ¸å¿ƒï¼šå¸¦åŒæ–¹å¤´åƒï¼‰
        function addMessage(content, type, emotion = 'normal') {
            // åˆ›å»ºæ¶ˆæ¯å®¹å™¨ï¼ˆå¤´åƒ+æ°”æ³¡ï¼‰
            const msgContainer = document.createElement('div');
            // åˆ›å»ºå¤´åƒå…ƒç´ 
            const avatar = document.createElement('div');
            // åˆ›å»ºæ¶ˆæ¯æ°”æ³¡
            const messageDiv = document.createElement('div');

            // åŒºåˆ†ç”¨æˆ·/AIæ¶ˆæ¯çš„æ ·å¼å’Œå†…å®¹
            if (type === 'user') {
                // ç”¨æˆ·æ¶ˆæ¯ï¼šå®¹å™¨å³å¯¹é½ã€å¤´åƒè“è‰²ï¼ˆç”¨æˆ·ï¼‰ã€æ°”æ³¡è“è‰²
                msgContainer.className = 'msg-container user-msg-wrap';
                avatar.className = 'msg-avatar user-avatar';
                avatar.innerHTML = '<i class="fas fa-user"></i>';
                messageDiv.className = 'message user-msg';
            } else {
                // AIæ¶ˆæ¯ï¼šå®¹å™¨å·¦å¯¹é½ã€å¤´åƒæµ…è“ï¼ˆå°ç›ˆï¼‰ã€æ°”æ³¡æµ…è“
                msgContainer.className = 'msg-container ai-msg-wrap';
                avatar.className = 'msg-avatar ai-avatar';
                avatar.innerHTML = '<i class="fas fa-girl"></i>';
                messageDiv.className = 'message ai-msg';
                messageDiv.dataset.emotion = emotion;
            }

            // ç»„è£…æ¶ˆæ¯ç»“æ„ï¼šå®¹å™¨ -> å¤´åƒ + æ°”æ³¡
            messageDiv.innerText = content;
            msgContainer.appendChild(avatar);
            msgContainer.appendChild(messageDiv);
            chatWindow.appendChild(msgContainer);

            // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
            chatWindow.scrollTop = chatWindow.scrollHeight;


        }
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼ˆå¸¦å°ç›ˆå¤´åƒï¼Œé€‚é…å¸ƒå±€ï¼‰
            function showLoading() {
                const loadingWrap = document.createElement('div');
                const avatar = document.createElement('div');
                const loadingDiv = document.createElement('div');

                loadingWrap.className = 'loading-wrap';
                avatar.className = 'msg-avatar ai-avatar';
                avatar.innerHTML = '<i class="fas fa-girl"></i>';
                loadingDiv.className = 'loading';
                loadingDiv.id = 'loading-animation';
                loadingDiv.innerHTML = `
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            `;

                loadingWrap.appendChild(avatar);
                loadingWrap.appendChild(loadingDiv);
                chatWindow.appendChild(loadingWrap);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        // ç§»é™¤åŠ è½½åŠ¨ç”»
        function removeLoading() {
            const loading = document.getElementById('loading-animation');
            if (loading) loading.parentElement.remove();
        }

    </script>
</body>
</html>
